<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="x509certificategenerator.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>x509certificategenerator.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		Simple X509 generator class<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="X509CertificateGenerator.html">X509CertificateGenerator</a></b></td>
    <td>Class implementing a X.509 certificate generator
 </td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

	<a name="method_summary"><!-- --></a>
	<table border="1" cellpadding="3" cellspacing="0" width="100%">
		<tr bgcolor="#CCCCFF" class="TableHeadingColor">
			<td colspan=2>
				<font size="+2">
					<b>Method Summary</b>
				</font>
			</td>
		</tr>
	
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!X509CertificateGeneratorECCTest">X509CertificateGeneratorECCTest</a></b>()
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 
		      </td>
		   </tr>
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!X509CertificateGeneratorRSATest">X509CertificateGeneratorRSATest</a></b>()
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 
		      </td>
		   </tr>
		
	
	</table>
    <p>

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/**
 *  ---------
 * |.##&gt; &lt;##.|  Open Smart Card Development Platform (www.openscdp.org)
 * |#       #|  
 * |#       #|  Copyright (c) 1999-2009 CardContact Software &amp; System Consulting
 * |'##&gt; &lt;##'|  Andreas Schwier, 32429 Minden, Germany (www.cardcontact.de)
 *  --------- 
 *
 *  This file is part of OpenSCDP.
 *
 *  OpenSCDP is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License version 2 as
 *  published by the Free Software Foundation.
 *
 *  OpenSCDP is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OpenSCDP; if not, write to the Free Software
 *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * <span class="attrib">@fileoverview</span>
 * Simple X509 generator class
 */</span>



<span class="comment">/**
 * Create a X.509 certificate generator.
 *
 * <span class="attrib">@class</span> Class implementing a X.509 certificate generator
 * <span class="attrib">@constructor</span>
 *
 * <span class="attrib">@param</span> {Crypto} crypto the crypto provider to use for signing operations
 */</span>
<span class="reserved">function</span> X509CertificateGenerator(crypto) {
	<span class="reserved">this</span>.crypto = crypto;
	<span class="reserved">this</span>.encodeECDomainParameter = true;
	<span class="reserved">this</span>.reset();
}



<span class="comment">/**
 * Resets all internal state variables.
 *
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.reset = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.extensions = new Array();
	
}



<span class="comment">/**
 * Sets the serial number.
 *
 * <span class="attrib">@param</span> {ByteString} serialNumber the serial number for the certificate
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setSerialNumber = <span class="reserved">function</span>(serialNumber) {
	<span class="reserved">this</span>.serialNumber = serialNumber;
}



<span class="comment">/**
 * Sets the isser name.
 *
 * &lt;p&gt;The issuer name must be a JavaScript object containing the properties:&lt;/p&gt;
 * &lt;ul&gt;
 *  &lt;li&gt;C - the country&lt;/li&gt;
 *  &lt;li&gt;O - the organization&lt;/li&gt;
 *  &lt;li&gt;OU - the organization unit&lt;/li&gt;
 *  &lt;li&gt;CN - the common name&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;Example:&lt;/p&gt;
 * &lt;pre&gt;
 *	var issuer = { C:"UT", O:"ACME Corporation", CN:"Test-CA" };
 * &lt;/pre&gt;
 * <span class="attrib">@param</span> {Object} issuer the issuer name
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setIssuer = <span class="reserved">function</span>(issuer) {
	<span class="reserved">this</span>.issuer = issuer;
}



<span class="comment">/**
 * Sets the effective date for the certificate.
 *
 * <span class="attrib">@param</span> {String} date the date in format YYMMDDHHMMSSZ
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setNotBefore = <span class="reserved">function</span>(date) {
	<span class="reserved">this</span>.notBefore = date;
}



<span class="comment">/**
 * Sets the expiration date for the certificate.
 *
 * <span class="attrib">@param</span> {String} date the date in format YYMMDDHHMMSSZ
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setNotAfter = <span class="reserved">function</span>(date) {
	<span class="reserved">this</span>.notAfter = date;
}



<span class="comment">/**
 * Sets the subject name.
 *
 * &lt;p&gt;The subject name must be a JavaScript object containing the properties:&lt;/p&gt;
 * &lt;ul&gt;
 *  &lt;li&gt;C - the country&lt;/li&gt;
 *  &lt;li&gt;O - the organization&lt;/li&gt;
 *  &lt;li&gt;OU - the organization unit&lt;/li&gt;
 *  &lt;li&gt;CN - the common name&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;Example:&lt;/p&gt;
 * &lt;pre&gt;
 *	var subject = { C:"UT", O:"ACME Corporation", CN:"Joe Doe" };
 * &lt;/pre&gt;
 * <span class="attrib">@param</span> {Object} subject the subject name
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setSubject = <span class="reserved">function</span>(subject) {
	<span class="reserved">this</span>.subject = subject;
}



<span class="comment">/**
 * Sets the subjects public key
 *
 * &lt;p&gt;The methods accepts ECC and RSA Public Keys.&lt;/p&gt;
 *
 * <span class="attrib">@param</span> {Key} publicKey the subjects public key
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setPublicKey = <span class="reserved">function</span>(publicKey) {
	<span class="reserved">this</span>.publicKey = publicKey;
}



<span class="comment">/**
 * Sets the signature algorithm. Currently only Crypto.RSA is supported
 *
 * <span class="attrib">@param</span> {Number} alg the signature algorithm, only Crypto.RSA supported
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.setSignatureAlgorithm = <span class="reserved">function</span>(alg) {
	<span class="reserved">this</span>.signatureAlgorithm = alg;
}



<span class="comment">/**
 * Adds an extension to the certificate
 *
 * &lt;p&gt;The structure is defined as:&lt;/p&gt;
 * &lt;pre&gt;
 *    Extension  ::=  SEQUENCE  {
 *        extnID      OBJECT IDENTIFIER,
 *        critical    BOOLEAN DEFAULT FALSE,
 *        extnValue   OCTET STRING
 *                    -- contains the DER encoding of an ASN.1 value
 *                    -- corresponding to the extension type identified
 *                    -- by extnID
 *        }
 *&lt;/pre&gt;
 * <span class="attrib">@param</span> {String} extnID the extensions object identifier
 * <span class="attrib">@param</span> {Boolean} critical the extension is critical
 * <span class="attrib">@param</span> {ByteString} the extension value as ByteString
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.addExtension = <span class="reserved">function</span>(extnID, critical, extnValue) {
	var t = new ASN1(<span class="literal">"extension"</span>, ASN1.SEQUENCE,
				new ASN1(<span class="literal">"extnID"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(extnID, OID))
			);

	<span class="reserved">if</span> (critical) {
		t.add(new ASN1(<span class="literal">"critical"</span>, ASN1.BOOLEAN, new ByteString(<span class="literal">"FF"</span>, HEX)));
	}

	t.add(new ASN1(<span class="literal">"extnValue"</span>, ASN1.OCTET_STRING, extnValue));
	<span class="reserved">this</span>.extensions.push(t);

}



<span class="comment">/**
 * Converts the integer value into a BIT STRING value.
 * &lt;p&gt;The function interprets the integer value as bitmap, where
 * bit 0 is the most significant bit of the least significant byte.&lt;/p&gt;
 * &lt;p&gt;The function adds the minimum number of bytes to the final bit string
 * and encodes the "number of unused bits at the beginning.&lt;/p&gt;
 * 
 * <span class="attrib">@param</span> {Number} val the value to convert
 * <span class="attrib">@return</span> the bit string
 * <span class="attrib">@type</span> ByteString
 */</span>
X509CertificateGenerator.bitstringForInteger = <span class="reserved">function</span>(val) {
	var bb = new ByteBuffer();
	var b = 0;
	
	<span class="comment">// Encode starting with the least significant byte</span>
	<span class="reserved">while</span> (val &gt; 0) {
		b = val &amp; 0xFF;
		bb.append(b);
		val = val &gt;&gt; 8;
	}
	
	<span class="comment">// Determine number of unused bits</span>
	var i = 0;
	<span class="reserved">while</span> ((i &lt; 8) &amp;&amp; !(b &amp; 1)) {
		i++;
		b &gt;&gt;= 1;
	}
	
	bb.insert(0, i);
	<span class="reserved">return</span> bb.toByteString();
}



<span class="comment">/**
 * Adds the key usage extension.
 *
 * &lt;p&gt;The following flags are defined:&lt;/p&gt;
 * &lt;pre&gt;
 * X509CertificateGenerator.digitalSignature = 0x0080;
 * X509CertificateGenerator.nonRepudiation   = 0x0040;
 * X509CertificateGenerator.keyEncipherment  = 0x0020;
 * X509CertificateGenerator.dataEncipherment = 0x0010;
 * X509CertificateGenerator.keyAgreement     = 0x0008;
 * X509CertificateGenerator.keyCertSign      = 0x0004;
 * X509CertificateGenerator.cRLSign          = 0x0002;
 * X509CertificateGenerator.encipherOnly     = 0x0001;
 * X509CertificateGenerator.decipherOnly     = 0x8000;
 * &lt;/pre&gt;
 * <span class="attrib">@param</span> {Number} the key usage flags as combination of the flags defined above.
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.addKeyUsageExtension = <span class="reserved">function</span>(flags) {
	var t = new ASN1(ASN1.BIT_STRING, X509CertificateGenerator.bitstringForInteger(flags));
	<span class="reserved">this</span>.addExtension(<span class="literal">"2.5.29.15"</span>, true, t.getBytes());
}

X509CertificateGenerator.digitalSignature	= 0x0080;
X509CertificateGenerator.nonRepudiation		= 0x0040;
X509CertificateGenerator.keyEncipherment	= 0x0020;
X509CertificateGenerator.dataEncipherment	= 0x0010;
X509CertificateGenerator.keyAgreement		= 0x0008;
X509CertificateGenerator.keyCertSign		= 0x0004;
X509CertificateGenerator.cRLSign			= 0x0002;
X509CertificateGenerator.encipherOnly		= 0x0001;
X509CertificateGenerator.decipherOnly		= 0x8000;



<span class="comment">/**
 * Adds the BasicConstraints extension.
 *
 * <span class="attrib">@param</span> {Boolean} cA the certificate belongs to a CA
 * <span class="attrib">@param</span> {Number} pathLenConstraint the maximum number of subordinate CA certificates
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.addBasicConstraintsExtension = <span class="reserved">function</span>(cA, pathLenConstraint) {
	var t = new ASN1(<span class="literal">"BasicConstraints"</span>,ASN1.SEQUENCE);
	<span class="reserved">if</span> (cA) {
		t.add(new ASN1(<span class="literal">"cA"</span>, ASN1.BOOLEAN, new ByteString(<span class="literal">"FF"</span>, HEX)));
	}
	<span class="reserved">if</span> (pathLenConstraint &gt;= 0) {
		var bb = new ByteBuffer();
		bb.append(pathLenConstraint);
		t.add(new ASN1(<span class="literal">"pathLenConstraint"</span>, ASN1.INTEGER, bb.toByteString()));
	}
	<span class="reserved">this</span>.addExtension(<span class="literal">"2.5.29.19"</span>, true, t.getBytes());
}



<span class="comment">/**
 * Adds the subject public key identifier extension based on the certificates subject key.
 *
 * &lt;p&gt;The key identifier is calculated as SHA-1 hash over the contents of the
 * subject public key (Without tag, length and number of unused bits.&lt;/p&gt;
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.addSubjectKeyIdentifierExtension = <span class="reserved">function</span>() {
	var spi = <span class="reserved">this</span>.getSubjectPublicKeyInfo();
	var keyvalue = spi.get(1).value.bytes(1);
	var hash = <span class="reserved">this</span>.crypto.digest(Crypto.SHA_1, keyvalue);
	
	var t = new ASN1(ASN1.OCTET_STRING, hash);
	<span class="reserved">this</span>.addExtension(<span class="literal">"2.5.29.14"</span>, false, t.getBytes());
}



<span class="comment">/**
 * Adds the authority public key identifier extension based on the issuers key.
 *
 * &lt;p&gt;The key identifier is calculated as SHA-1 hash over the contents of the
 * issuer public key (Without tag, length and number of unused bits.&lt;/p&gt;
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.addAuthorityKeyIdentifierExtension = <span class="reserved">function</span>(publicKey) {
	<span class="reserved">if</span> (publicKey.getComponent(Key.MODULUS)) {
		var spi = X509CertificateGenerator.createRSASubjectPublicKeyInfo(publicKey);
	} <span class="reserved">else</span> {
		var spi = X509CertificateGenerator.createECSubjectPublicKeyInfo(publicKey, <span class="reserved">this</span>.encodeECDomainParameter);
	}

	var keyvalue = spi.get(1).value.bytes(1);
	var hash = <span class="reserved">this</span>.crypto.digest(Crypto.SHA_1, keyvalue);
	
	var t = new ASN1(ASN1.SEQUENCE,
					new ASN1(0x80, hash)
				);
	<span class="reserved">this</span>.addExtension(<span class="literal">"2.5.29.35"</span>, false, t.getBytes());
}



<span class="comment">/**
 * Creates a relative distinguished name component.
 *
 * &lt;p&gt;The structure is defined as:&lt;/p&gt;
 * &lt;pre&gt;
 *	RelativeDistinguishedName ::=
 *		SET SIZE (1..MAX) OF AttributeTypeAndValue
 *
 *	AttributeTypeAndValue ::= SEQUENCE {
 *		type     AttributeType,
 *		value    AttributeValue }
 *
 *	AttributeType ::= OBJECT IDENTIFIER
 *
 *	AttributeValue ::= ANY -- DEFINED BY AttributeType
 *
 *	DirectoryString ::= CHOICE {
 *		teletexString           TeletexString (SIZE (1..MAX)),
 *		printableString         PrintableString (SIZE (1..MAX)),
 *		universalString         UniversalString (SIZE (1..MAX)),
 *		utf8String              UTF8String (SIZE (1..MAX)),
 *		bmpString               BMPString (SIZE (1..MAX)) }
 *&lt;/pre&gt;
 *
 * <span class="attrib">@param</span> {String} name the components name
 * <span class="attrib">@param</span> {String} oid the oid for the RDN
 * <span class="attrib">@param</span> {ASN1} value the value object
 * <span class="attrib">@return</span> the 
 */</span>
X509CertificateGenerator.makeRDN = <span class="reserved">function</span>(name, oid, value) {
	<span class="reserved">return</span> new ASN1(name, ASN1.SET,
				new ASN1(ASN1.SEQUENCE,
					new ASN1(ASN1.OBJECT_IDENTIFIER, new ByteString(oid, OID)),
					value
				)
			);
}



<span class="comment">/**
 * Adds names from the name object to the RDNSequence.
 *
 * <span class="attrib">@param</span> {ASN1} t the sequence object
 * <span class="attrib">@param</span> {Object} name the name object
 */</span>
X509CertificateGenerator.addNames = <span class="reserved">function</span>(t, name) {
	<span class="reserved">if</span> (name.T) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"title"</span>, <span class="literal">"2.5.4.12"</span>, new ASN1(ASN1.UTF8String, new ByteString(name.T, UTF8))));
	}
	<span class="reserved">if</span> (name.G) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"givenName"</span>, <span class="literal">"2.5.4.42"</span>, new ASN1(ASN1.UTF8String, new ByteString(name.G, UTF8))));
	}
	<span class="reserved">if</span> (name.SN) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"surname"</span>, <span class="literal">"2.5.4.4"</span>, new ASN1(ASN1.UTF8String, new ByteString(name.SN, UTF8))));
	}
	<span class="reserved">if</span> (name.CN) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"commonName"</span>, <span class="literal">"2.5.4.3"</span>, new ASN1(ASN1.UTF8String, new ByteString(name.CN, UTF8))));
	}
	<span class="reserved">if</span> (name.OU) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"organizationalUnit"</span>, <span class="literal">"2.5.4.11"</span>, new ASN1(ASN1.UTF8String, new ByteString(name.OU, UTF8))));
	}
	<span class="reserved">if</span> (name.O) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"organization"</span>, <span class="literal">"2.5.4.10"</span>, new ASN1(ASN1.UTF8String, new ByteString(name.O, UTF8))));
	}
	<span class="reserved">if</span> (name.C) {
		t.add(X509CertificateGenerator.makeRDN(<span class="literal">"country"</span>, <span class="literal">"2.5.4.6"</span>, new ASN1(ASN1.PrintableString, new ByteString(name.C, ASCII))));
	}
<span class="comment">/*	
X509Name.name = "550429";
X509Name.surname = "550404";
X509Name.givenname = "55042A";
X509Name.initials = "55042B";
X509Name.generationQualifier = "55042C";
X509Name.localityName = "550407";
X509Name.stateOrProvinceName = "550408";
X509Name.title = "55040C";
X509Name.dnQualifier = "55042C";
X509Name.serialNumber = "550405";
X509Name.emailAddress = "2A864886F70D010901";

X509Name.commonName = "550403";
X509Name.organizationalUnitName = "55040B";
X509Name.organizationName = "55040A";
X509Name.countryName = "550406";
*/</span>
}



<span class="comment">/**
 * Gets the issuer name as TLV object
 *
 * <span class="attrib">@return</span> the issuer RDNSequence
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getIssuer = <span class="reserved">function</span>() {
	var t = new ASN1(<span class="literal">"issuer"</span>, ASN1.SEQUENCE);
	X509CertificateGenerator.addNames(t, <span class="reserved">this</span>.issuer);
	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Gets the certificate validity as TLV object
 *
 * <span class="attrib">@return</span> the certificates validity
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getValidity = <span class="reserved">function</span>() {
	var t = new ASN1(<span class="literal">"validity"</span>, ASN1.SEQUENCE);
	t.add(new ASN1(<span class="literal">"notBefore"</span>, ASN1.UTCTime, new ByteString(<span class="reserved">this</span>.notBefore, ASCII)));
	t.add(new ASN1(<span class="literal">"notAfter"</span>, ASN1.UTCTime, new ByteString(<span class="reserved">this</span>.notAfter, ASCII)));
	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Gets the subject name as TLV object
 *
 * <span class="attrib">@return</span> the issuer RDNSequence
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getSubject = <span class="reserved">function</span>() {
	var t = new ASN1(<span class="literal">"subject"</span>, ASN1.SEQUENCE);
	X509CertificateGenerator.addNames(t, <span class="reserved">this</span>.subject);
	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Prepends a '00' to ByteStrings which have the most significant bit set.
 *
 * This prevent interpretation of the integer representation if converted into
 * a signed ASN1 INTEGER.
 *
 * <span class="attrib">@param</span> {ByteString} value the value to convert
 * <span class="attrib">@return</span> the converted value
 * <span class="attrib">@type</span> ByteString
 */</span>
X509CertificateGenerator.convertUnsignedInteger = <span class="reserved">function</span>(value) {
	<span class="reserved">if</span> (value.byteAt(0) &gt;= 0x80) {
		value = (new ByteString(<span class="literal">"00"</span>, HEX)).concat(value);
	}
	<span class="reserved">return</span> value;
}



<span class="comment">/**
 * Creates the EC Public Key as subjectPublicKeyInfo TLV structure object.
 *
 * &lt;p&gt;The structure is defined as:&lt;/p&gt;
 * &lt;pre&gt;
 *	SubjectPublicKeyInfo  ::=  SEQUENCE  {
 *		algorithm            AlgorithmIdentifier,
 *		subjectPublicKey     BIT STRING  }
 *
 *	AlgorithmIdentifier  ::=  SEQUENCE  {
 *		algorithm               OBJECT IDENTIFIER,
 *		parameters              ANY DEFINED BY algorithm OPTIONAL  }
 * 
 *	id-ecPublicKey OBJECT IDENTIFIER ::= {
 *		iso(1) member-body(2) us(840) ansi-X9-62(10045) keyType(2) 1 }
 *
 *	ECParameters ::= CHOICE {
 *		namedCurve         OBJECT IDENTIFIER,
 *		implicitCurve      NULL,
 *		specifiedCurve     SpecifiedECDomain }
 * 
 * <span class="attrib">@return</span> the subjectPublicKey TLV structure
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.createECSubjectPublicKeyInfo = <span class="reserved">function</span>(publicKey, encodeECDomainParameter) {
	var t = new ASN1(<span class="literal">"subjectPublicKeyInfo"</span>, ASN1.SEQUENCE);

	var algorithm = new ASN1(<span class="literal">"algorithm"</span>, ASN1.SEQUENCE,
			new ASN1(<span class="literal">"algorithm"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(<span class="literal">"1.2.840.10045.2.1"</span>, OID))
		);

	<span class="reserved">if</span> (encodeECDomainParameter) {
		var ecParameter = 
			new ASN1(<span class="literal">"ecParameters"</span>, ASN1.SEQUENCE,
				new ASN1(<span class="literal">"version"</span>, ASN1.INTEGER, new ByteString(<span class="literal">"01"</span>, HEX)),
				new ASN1(<span class="literal">"fieldID"</span>, ASN1.SEQUENCE,
					new ASN1(<span class="literal">"fieldType"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(<span class="literal">"prime-field"</span>, OID)),
					new ASN1(<span class="literal">"prime"</span>, ASN1.INTEGER, 
						X509CertificateGenerator.convertUnsignedInteger(publicKey.getComponent(Key.ECC_P)))
				),
				new ASN1(<span class="literal">"curve"</span>, ASN1.SEQUENCE,
					new ASN1(<span class="literal">"a"</span>, ASN1.OCTET_STRING, 
						X509CertificateGenerator.convertUnsignedInteger(publicKey.getComponent(Key.ECC_A))),
					new ASN1(<span class="literal">"a"</span>, ASN1.OCTET_STRING, 
						X509CertificateGenerator.convertUnsignedInteger(publicKey.getComponent(Key.ECC_B)))
				),
				new ASN1(<span class="literal">"base"</span>, ASN1.OCTET_STRING,
						(new ByteString(<span class="literal">"04"</span>, HEX)).concat(publicKey.getComponent(Key.ECC_GX)).concat(publicKey.getComponent(Key.ECC_GY))),
				new ASN1(<span class="literal">"order"</span>, ASN1.INTEGER,
					X509CertificateGenerator.convertUnsignedInteger(publicKey.getComponent(Key.ECC_N)))
			);
		
		var cofactor = publicKey.getComponent(Key.ECC_H);
		var i = 0;
		<span class="reserved">for</span> (; (i &lt; cofactor.length) &amp;&amp; (cofactor.byteAt(i) == 0); i++);
		<span class="reserved">if</span> (i &lt; cofactor.length) {
			ecParameter.add(new ASN1(<span class="literal">"cofactor"</span>, ASN1.INTEGER, cofactor.bytes(i)));
		}
		algorithm.add(ecParameter);	
	} <span class="reserved">else</span> {
		algorithm.add(new ASN1(<span class="literal">"parameters"</span>, ASN1.OBJECT_IDENTIFIER, publicKey.getComponent(Key.ECC_CURVE_OID)));
	}
	
	t.add(algorithm);
	
	<span class="comment">// Prefix a 00 to form correct bitstring</span>
	<span class="comment">// Prefix a 04 to indicate uncompressed format</span>
	var keybin = new ByteString(<span class="literal">"0004"</span>, HEX);
	keybin = keybin.concat(publicKey.getComponent(Key.ECC_QX));
	keybin = keybin.concat(publicKey.getComponent(Key.ECC_QY));
	t.add(new ASN1(<span class="literal">"subjectPublicKey"</span>, ASN1.BIT_STRING, keybin));

	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Creates the RSA Public Key as subjectPublicKeyInfo TLV structure object.
 *
 * &lt;p&gt;The structure is defined as:&lt;/p&gt;
 * &lt;pre&gt;
 *	SubjectPublicKeyInfo  ::=  SEQUENCE  {
 *		algorithm            AlgorithmIdentifier,
 *		subjectPublicKey     BIT STRING  }
 *
 *	AlgorithmIdentifier  ::=  SEQUENCE  {
 *		algorithm               OBJECT IDENTIFIER,
 *		parameters              ANY DEFINED BY algorithm OPTIONAL  }
 * 
 *	pkcs-1 OBJECT IDENTIFIER ::= { iso(1) member-body(2) us(840) rsadsi(113549) pkcs(1) 1 }
 *
 *	rsaEncryption OBJECT IDENTIFIER ::=  { pkcs-1 1}
 *
 *	RSAPublicKey ::= SEQUENCE {
 *		modulus            INTEGER,    -- n
 *		publicExponent     INTEGER  }  -- e
 * &lt;/pre&gt;
 *
 * <span class="attrib">@return</span> the subjectPublicKey TLV structure
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.createRSASubjectPublicKeyInfo = <span class="reserved">function</span>(publicKey) {
	var t = new ASN1(<span class="literal">"subjectPublicKeyInfo"</span>, ASN1.SEQUENCE);
	
	t.add(new ASN1(<span class="literal">"algorithm"</span>, ASN1.SEQUENCE,
		new ASN1(<span class="literal">"algorithm"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(<span class="literal">"1.2.840.113549.1.1.1"</span>, OID)),
		new ASN1(<span class="literal">"parameters"</span>, ASN1.NULL, new ByteString(<span class="literal">""</span>, HEX))
	       ));
	<span class="comment">// Prefix a 00 to form correct bitstring</span>
	var keybin = new ByteString(<span class="literal">"00"</span>, HEX);

	var modulus = publicKey.getComponent(Key.MODULUS);
	modulus = X509CertificateGenerator.convertUnsignedInteger(modulus);
	
	var exponent = publicKey.getComponent(Key.EXPONENT);
	exponent = X509CertificateGenerator.convertUnsignedInteger(exponent);

	var rsapub = new ASN1(<span class="literal">"RSAPublicKey"</span>, ASN1.SEQUENCE,
			new ASN1(<span class="literal">"modulus"</span>, ASN1.INTEGER, modulus),
			new ASN1(<span class="literal">"publicKeyExponent"</span>, ASN1.INTEGER, exponent));

	keybin = keybin.concat(rsapub.getBytes());
	t.add(new ASN1(<span class="literal">"subjectPublicKey"</span>, ASN1.BIT_STRING, keybin));

	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Gets the subject's public key as TLV object
 *
 * <span class="attrib">@return</span> the subject's public key info
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getSubjectPublicKeyInfo = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.publicKey.getComponent(Key.MODULUS)) {
		<span class="reserved">return</span> X509CertificateGenerator.createRSASubjectPublicKeyInfo(<span class="reserved">this</span>.publicKey);
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> X509CertificateGenerator.createECSubjectPublicKeyInfo(<span class="reserved">this</span>.publicKey, <span class="reserved">this</span>.encodeECDomainParameter);
	}
}



<span class="comment">/**
 * Gets the certificate extension as TLV object
 *
 * <span class="attrib">@return</span> the certificate extensions
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getExtensions = <span class="reserved">function</span>() {
	var t = new ASN1(<span class="literal">"extensions"</span>, 0xA3);
	var s = new ASN1(<span class="literal">"extensions"</span>, ASN1.SEQUENCE);
	
	t.add(s);
	
	<span class="reserved">for</span> (var i = 0; i &lt; <span class="reserved">this</span>.extensions.length; i++) {
		s.add(<span class="reserved">this</span>.extensions[i]);
	}
	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Gets the part of the certificate that will be signed
 *
 * <span class="attrib">@return</span> the TBSCertificate part
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getTbsCertificate = <span class="reserved">function</span>() {
	var t = new ASN1(<span class="literal">"tbsCertificate"</span>, ASN1.SEQUENCE);
	t.add(new ASN1(<span class="literal">"version"</span>, 0xA0,
			new ASN1(<span class="literal">"version"</span>, ASN1.INTEGER, new ByteString(<span class="literal">"02"</span>, HEX))));
	t.add(new ASN1(<span class="literal">"serialNumber"</span>, ASN1.INTEGER, <span class="reserved">this</span>.serialNumber));
	t.add(<span class="reserved">this</span>.getSignatureAlgorithm());
	t.add(<span class="reserved">this</span>.getIssuer());
	t.add(<span class="reserved">this</span>.getValidity());
	t.add(<span class="reserved">this</span>.getSubject());
	t.add(<span class="reserved">this</span>.getSubjectPublicKeyInfo());
	t.add(<span class="reserved">this</span>.getExtensions());
	<span class="reserved">return</span> t;
}



<span class="comment">/**
 * Gets the signature algorithm TLV object
 *
 * <span class="attrib">@return</span> the signature algorithm object
 * <span class="attrib">@type</span> ASN1
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.getSignatureAlgorithm = <span class="reserved">function</span>() {
	var t = new ASN1(<span class="literal">"signatureAlgorithm"</span>, ASN1.SEQUENCE);

	<span class="reserved">if</span> (<span class="reserved">this</span>.signatureAlgorithm == Crypto.RSA) {
		t.add(new ASN1(<span class="literal">"algorithm"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(<span class="literal">"1.2.840.113549.1.1.5"</span>, OID)));
		t.add(new ASN1(<span class="literal">"parameters"</span>, ASN1.NULL, new ByteString(<span class="literal">""</span>, HEX)));
	} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.signatureAlgorithm == Crypto.RSA_SHA256) {
		t.add(new ASN1(<span class="literal">"algorithm"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(<span class="literal">"1.2.840.113549.1.1.11"</span>, OID)));
		t.add(new ASN1(<span class="literal">"parameters"</span>, ASN1.NULL, new ByteString(<span class="literal">""</span>, HEX)));
	} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.signatureAlgorithm == Crypto.ECDSA_SHA256) {
		t.add(new ASN1(<span class="literal">"algorithm"</span>, ASN1.OBJECT_IDENTIFIER, new ByteString(<span class="literal">"ecdsa-with-SHA256"</span>, OID)));
		t.add(new ASN1(<span class="literal">"parameters"</span>, ASN1.NULL, new ByteString(<span class="literal">""</span>, HEX)));
	} <span class="reserved">else</span> {
		throw new GPError(<span class="literal">"X509CertificateGenerator"</span>, GPError.INVALID_MECH, <span class="reserved">this</span>.signatureAlgorithm, <span class="literal">"Invalid algorithm"</span>);
	}
		
	<span class="reserved">return</span> t;
}

 

<span class="comment">/**
 * Generates the certificate.
 *
 * <span class="attrib">@return</span> the generated certificate
 * <span class="attrib">@type</span> X509
 */</span>
X509CertificateGenerator.<span class="reserved">prototype</span>.generateX509Certificate = <span class="reserved">function</span>(privateKey) {
	var certificate = new ASN1(<span class="literal">"certificate"</span>, ASN1.SEQUENCE);
	
	var tbs = <span class="reserved">this</span>.getTbsCertificate();
	certificate.add(tbs);
	certificate.add(<span class="reserved">this</span>.getSignatureAlgorithm());
	
	var signature = <span class="reserved">this</span>.crypto.sign(privateKey, <span class="reserved">this</span>.signatureAlgorithm, tbs.getBytes());
	signature = (new ByteString(<span class="literal">"00"</span>, HEX)).concat(signature);

	var signatureValue = new ASN1(<span class="literal">"signatureValue"</span>, ASN1.BIT_STRING, signature);
	certificate.add(signatureValue);
	
<span class="comment">//	print(certificate);</span>
	<span class="reserved">return</span> new X509(certificate.getBytes());
}



<span class="comment">/**
 * Writes a byte string object to file
 *
 * &lt;p&gt;The filename is mapped to the workspace location.&lt;/p&gt;
 *
 * <span class="attrib">@param</span> {String} name the name of the file
 * <span class="attrib">@param</span> {ByteString} content the content to write
 */</span>
 
X509CertificateGenerator.writeFileToDisk = <span class="reserved">function</span>(name, content) {

	<span class="comment">// Map filename</span>
	var filename = GPSystem.mapFilename(name, GPSystem.USR);
	print(<span class="literal">"Writing "</span> + filename);

	var file = new java.io.FileOutputStream(filename);
	file.write(content);
	file.close();
}



<span class="reserved">function</span> X509CertificateGeneratorRSATest() {

	var crypto = new Crypto();
	
	var caPrivateKey = new Key();
	caPrivateKey.setType(Key.PRIVATE);

	var caPublicKey = new Key();
	caPublicKey.setType(Key.PUBLIC);
	caPublicKey.setSize(1024);
	
	crypto.generateKeyPair(Crypto.RSA, caPublicKey, caPrivateKey);
	
<span class="comment">//	var caPrivKey = new Key("profiles/kp_rsa_private.xml");</span>

	var x = new X509CertificateGenerator(crypto);

	x.reset();
	x.setSerialNumber(new ByteString(<span class="literal">"01"</span>, HEX));
	x.setSignatureAlgorithm(Crypto.RSA);
	var issuer = { C:<span class="literal">"UT"</span>, O:<span class="literal">"ACME Corporation"</span>, CN:<span class="literal">"Test-CA"</span> };
	x.setIssuer(issuer);
	x.setNotBefore(<span class="literal">"060825120000Z"</span>);
	x.setNotAfter(<span class="literal">"160825120000Z"</span>);
	var subject = { C:<span class="literal">"UT"</span>, O:<span class="literal">"Utopia CA"</span>, OU:<span class="literal">"ACME Corporation"</span>, CN:<span class="literal">"Joe Doe"</span> };
	x.setSubject(subject);

	x.setPublicKey(caPublicKey);

	x.addKeyUsageExtension(	X509CertificateGenerator.digitalSignature |
							X509CertificateGenerator.keyCertSign |
							X509CertificateGenerator.cRLSign );
							
	x.addBasicConstraintsExtension(true, 0);
	x.addSubjectKeyIdentifierExtension();
	x.addAuthorityKeyIdentifierExtension(caPublicKey);

	var cert = x.generateX509Certificate(caPrivateKey);
	X509CertificateGenerator.writeFileToDisk(<span class="literal">"cert_rsa.cer"</span>, cert.getBytes());

	cert.verifyWith(cert);

	print(cert);
}



<span class="reserved">function</span> X509CertificateGeneratorECCTest() {

	var crypto = new Crypto();
	
	var caPrivateKey = new Key();
	caPrivateKey.setType(Key.PRIVATE);

	var caPublicKey = new Key();
	caPublicKey.setType(Key.PUBLIC);
	caPublicKey.setComponent(Key.ECC_CURVE_OID, new ByteString(<span class="literal">"brainpoolP256r1"</span>, OID));
	
	crypto.generateKeyPair(Crypto.EC, caPublicKey, caPrivateKey);

	var x = new X509CertificateGenerator(crypto);

	x.reset();
	x.setSerialNumber(new ByteString(<span class="literal">"01"</span>, HEX));
	x.setSignatureAlgorithm(Crypto.ECDSA_SHA256);
	var issuer = { C:<span class="literal">"UT"</span>, O:<span class="literal">"ACME Corporation"</span>, CN:<span class="literal">"Test-CA"</span> };
	x.setIssuer(issuer);
	x.setNotBefore(<span class="literal">"060825120000Z"</span>);
	x.setNotAfter(<span class="literal">"160825120000Z"</span>);
	var subject = { C:<span class="literal">"UT"</span>, O:<span class="literal">"Utopia CA"</span>, OU:<span class="literal">"ACME Corporation"</span>, CN:<span class="literal">"Joe Doe"</span> };
	x.setSubject(subject);

	x.setPublicKey(caPublicKey);

	x.addKeyUsageExtension(	X509CertificateGenerator.digitalSignature |
							X509CertificateGenerator.keyCertSign |
							X509CertificateGenerator.cRLSign );
							
	x.addBasicConstraintsExtension(true, 0);
	x.addSubjectKeyIdentifierExtension();
	x.addAuthorityKeyIdentifierExtension(caPublicKey);

	var cert = x.generateX509Certificate(caPrivateKey);
	X509CertificateGenerator.writeFileToDisk(<span class="literal">"cert_ecc.cer"</span>, cert.getBytes());

	cert.verifyWith(cert);
	
	print(cert);
	print(new ASN1(cert.getBytes()));
}

X509CertificateGeneratorECCTest();
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Fri Dec  3 18:14:23 2010</div>
</body>
</html>
