<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="p15classes.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>p15classes.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		Classes to parse PKCS#15 data structures<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="AlgorithmInfo.html">AlgorithmInfo</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15.html">PKCS15</a></b></td>
    <td><p>This class provides for direct access to a PKCS#15 data structure on a card.</p>
 <p>The calling application will typically use:</p>
 <pre>
 var card = new Card(_scsh3.reader);
 var p15 = new PKCS15(card);
 var appllist = p15.readApplicationDirectory();
 var aid;
 for (var i in appllist) {
   print(i);
   aid = i;
 }
 var at = appllist[aid];
 p15.readObjectListForApplication(at);
 for (var i = 0; i < at.objlist.length; i++) {
   print(at.objlist[i]);
 }
 </pre>
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_ApplicationTemplate.html">PKCS15_ApplicationTemplate</a></b></td>
    <td><p>This class provides for access to an application template.</p>
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_AuthenticationObject.html">PKCS15_AuthenticationObject</a></b></td>
    <td><p>This class adds authentication object attributes to the common authentication object class.</p>
 <p>The class supports password objects.</p>
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_Certificate.html">PKCS15_Certificate</a></b></td>
    <td><p>This class adds X.509 certificate attributes to the common certificate attribute class.</p>
 <p>The class decodes the following ASN.1 syntax for X.509 certificates:</p>
 <pre>
 X509CertificateAttributes ::= SEQUENCE {
 value ObjectValue { Certificate },
 subject Name OPTIONAL,
 issuer [0] Name OPTIONAL,
 serialNumber CertificateSerialNumber OPTIONAL,
 ...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CIAInfo.html">PKCS15_CIAInfo</a></b></td>
    <td><p>Class to decode CIAInfo objects.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CIAInfo ::= SEQUENCE {
		version INTEGER {v1(0),v2(1)} (v1|v2,...),
		serialNumber OCTET STRING OPTIONAL,
		manufacturerID Label OPTIONAL,
		label [0] Label OPTIONAL,
		cardflags CardFlags,
		seInfo SEQUENCE OF SecurityEnvironmentInfo OPTIONAL,
		recordInfo [1] RecordInfo OPTIONAL,
		supportedAlgorithms [2] SEQUENCE OF AlgorithmInfo OPTIONAL,
		issuerId [3] Label OPTIONAL,
		holderId [4] Label OPTIONAL,
		lastUpdate [5] LastUpdate OPTIONAL,
		preferredLanguage PrintableString OPTIONAL, -- In accordance with IETF RFC 1766
		profileIndication [6] SEQUENCE OF ProfileIndication OPTIONAL,
		...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CIO.html">PKCS15_CIO</a></b></td>
    <td><p>This is the base class for all cryptographic objects in a PKCS#15 data structure.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CommonObjectAttributes ::= SEQUENCE {
		label Label OPTIONAL,
		flags CommonObjectFlags OPTIONAL,
		authId Identifier OPTIONAL,
		userConsent INTEGER (1..cia-ub-userConsent) OPTIONAL,
		accessControlRules SEQUENCE SIZE (1..MAX) OF AccessControlRule OPTIONAL,
		...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CIODDO.html">PKCS15_CIODDO</a></b></td>
    <td><p>Class to decode CIO DDO objects.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CIODDO ::= SEQUENCE {
 		providerId OBJECT IDENTIFIER OPTIONAL,
 		odfPath Path OPTIONAL,
		ciaInfoPath [0] Path OPTIONAL,
		aid [APPLICATION 15] OCTET STRING (SIZE(1..16)),
		(CONSTRAINED BY {-- Must be an AID in accordance with ISO/IEC 7816-4--})
		OPTIONAL,
		...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CommonAuthenticationObjectAttributes.html">PKCS15_CommonAuthenticationObjectAttributes</a></b></td>
    <td><p>This class adds common authentication object attributes to the base CIO class.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CommonAuthenticationObjectAttributes ::= SEQUENCE {
    authId Identifier OPTIONAL,
    authReference Reference OPTIONAL,
    seIdentifier [0] Reference OPTIONAL,
    ...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CommonCertificateAttributes.html">PKCS15_CommonCertificateAttributes</a></b></td>
    <td><p>This class adds common certificate attributes to the base CIO class.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CommonCertificateAttributes ::= SEQUENCE {
 iD Identifier,
 authority BOOLEAN DEFAULT FALSE,
 identifier CredentialIdentifier {{KeyIdentifiers}} OPTIONAL,
 certHash [0] CertHash OPTIONAL,
 trustedUsage [1] Usage OPTIONAL,
 identifiers [2] SEQUENCE OF CredentialIdentifier {{KeyIdentifiers}} OPTIONAL,
 validity [4] Validity OPTIONAL,
 ...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CommonDataContainerObjectAttributes.html">PKCS15_CommonDataContainerObjectAttributes</a></b></td>
    <td><p>This class adds common data container attributes to the base CIO class.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CommonDataContainerObjectAttributes ::= SEQUENCE {
 		applicationName Label OPTIONAL,
 		applicationOID OBJECT IDENTIFIER OPTIONAL,
 		iD Identifier OPTIONAL,
 		...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CommonKeyAttributes.html">PKCS15_CommonKeyAttributes</a></b></td>
    <td><p>This class adds common key attributes to the base CIO class.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CommonKeyAttributes ::= SEQUENCE {
		iD Identifier,
		usage KeyUsageFlags,
		native BOOLEAN DEFAULT TRUE,
		accessFlags KeyAccessFlags OPTIONAL,
		keyReference KeyReference OPTIONAL,
		startDate GeneralizedTime OPTIONAL,
		endDate [0] GeneralizedTime OPTIONAL,
		algReference [1] SEQUENCE OF Reference OPTIONAL,
		...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_CommonPrivateKeyAttributes.html">PKCS15_CommonPrivateKeyAttributes</a></b></td>
    <td><p>This class adds common private key attributes to the common key attribute class.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 CommonPrivateKeyAttributes ::= SEQUENCE {
 name Name OPTIONAL,
 keyIdentifiers [0] SEQUENCE OF CredentialIdentifier {{KeyIdentifiers}} OPTIONAL,
 generalName [1] GeneralNames OPTIONAL,
 ...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_DataContainerObject.html">PKCS15_DataContainerObject</a></b></td>
    <td><p>This class adds data container objects to the common data container object attributes class.</p>
 <p>The class decodes the following ASN.1 syntax for opaque data objects with indirect path reference:</p>
 <pre>
 OpaqueDOAttributes ::= ObjectValue {CIO-OPAQUE.&Type}

</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_PasswordAuthenticationObject.html">PKCS15_PasswordAuthenticationObject</a></b></td>
    <td><p>This class supports password authentication objects.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 PasswordAttributes ::= SEQUENCE {
	pwdFlags PasswordFlags,
	pwdType PasswordType,
	minLength INTEGER (cia-lb-minPasswordLength..cia-ub-minPasswordLength),
	storedLength INTEGER (0..cia-ub-storedPasswordLength),
	maxLength INTEGER OPTIONAL,
	pwdReference [0] Reference DEFAULT 0,
	padChar OCTET STRING (SIZE(1)) OPTIONAL,
	lastPasswordChange GeneralizedTime OPTIONAL,
	path Path OPTIONAL,
	...</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_Path.html">PKCS15_Path</a></b></td>
    <td><p>This class provides for access to PKCS#15 structures.</p>
 <p>The class decodes the following ASN.1 syntax:</p>
 <pre>
 Path ::= SEQUENCE {
 		efidOrPath OCTET STRING,
		index INTEGER (0..cia-ub-index) OPTIONAL,
		length [0] INTEGER (0..cia-ub-index) OPTIONAL
	}( WITH COMPONENTS {..., index PRESENT, length PRESENT}|
 	   WITH COMPONENTS {..., index ABSENT, length ABSENT})
 </pre>
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PKCS15_PrivateKey.html">PKCS15_PrivateKey</a></b></td>
    <td><p>This class adds private key attributes to the common private key attribute class.</p>
 <p>The class supports RSA and ECC keys.</p>
 <p>RSA keys are decoded from the following ASN.1 structure:</p>
 <pre>
 PrivateRSAKeyAttributes ::= SEQUENCE {
 value Path,
 modulusLength INTEGER, -- modulus length in bits, e.g.</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

	<a name="method_summary"><!-- --></a>
	<table border="1" cellpadding="3" cellspacing="0" width="100%">
		<tr bgcolor="#CCCCFF" class="TableHeadingColor">
			<td colspan=2>
				<font size="+2">
					<b>Method Summary</b>
				</font>
			</td>
		</tr>
	
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;Number</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!IntFromBitString">IntFromBitString</a></b>(b)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 Return the BIT STRING as integer value
		      </td>
		   </tr>
		
	
	</table>
    <p>

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/**
 *  ---------
 * |.##&gt; &lt;##.|  Open Smart Card Development Platform (www.openscdp.org)
 * |#       #|  
 * |#       #|  Copyright (c) 1999-2006 CardContact Software &amp; System Consulting
 * |'##&gt; &lt;##'|  Andreas Schwier, 32429 Minden, Germany (www.cardcontact.de)
 *  --------- 
 *
 *  This file is part of OpenSCDP.
 *
 *  OpenSCDP is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License version 2 as
 *  published by the Free Software Foundation.
 *
 *  OpenSCDP is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with OpenSCDP; if not, write to the Free Software
 *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 *  <span class="attrib">@fileoverview</span>
 *  Classes to parse PKCS#15 data structures
 */</span>



<span class="comment">/** 
 * Return the BIT STRING as integer value
 * 
 * <span class="attrib">@param</span> {ByteString} the ASN.1 BIT STRING to convert
 * <span class="attrib">@return</span> the converted integer
 * <span class="attrib">@type</span> Number
 */</span>
<span class="reserved">function</span> IntFromBitString(b) {
	assert(b.length &lt; 5);
	var bits = b.bytes(1).toUnsigned();
	<span class="reserved">return</span> bits &lt;&lt; ((4 - b.length) &lt;&lt; 3);
}

<span class="comment">/*
print("0080 - ", IntFromBitString(new ByteString("0080", HEX)).toString(16));
print("0180 - ", IntFromBitString(new ByteString("0180", HEX)).toString(16));
print("0780 - ", IntFromBitString(new ByteString("0780", HEX)).toString(16));
print("078000 - ", IntFromBitString(new ByteString("078000", HEX)).toString(16));
print("07800000 - ", IntFromBitString(new ByteString("07800000", HEX)).toString(16));
*/</span>



<span class="comment">/**
 * Creates a PKCS#15 path from the encoded TLV structure
 * 
 * <span class="attrib">@class</span> &lt;p&gt;This class provides for access to PKCS#15 structures.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * Path ::= SEQUENCE {
 * 		efidOrPath OCTET STRING,
 *		index INTEGER (0..cia-ub-index) OPTIONAL,
 *		length [0] INTEGER (0..cia-ub-index) OPTIONAL
 *	}( WITH COMPONENTS {..., index PRESENT, length PRESENT}|
 * 	   WITH COMPONENTS {..., index ABSENT, length ABSENT})
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the path
 */</span>
<span class="reserved">function</span> PKCS15_Path(tlv) {
	assert(tlv.elements &gt; 0);

	var t = tlv.get(0);
	assert(t.tag == ASN1.OCTET_STRING);

	t.setName(<span class="literal">"efidOrPath"</span>);
	<span class="reserved">this</span>.efidOrPath = <span class="literal">""</span>;
	<span class="reserved">for</span> (var i = 0; i &lt; t.length; i += 2) {
		<span class="reserved">this</span>.efidOrPath += <span class="literal">":"</span> + t.value.bytes(i, 2).toString(HEX);
	}

	<span class="reserved">if</span> (tlv.elements == 3) {
		t = tlv.get(1);
		assert(t.tag == ASN1.INTEGER);
		assert(t.length &gt; 0);
		t.setName(<span class="literal">"index"</span>);
		<span class="reserved">this</span>.index = t.value.toSigned();

		t = tlv.get(2);
		assert(t.tag == 0x80);
		assert(t.length &gt; 0);
		t.setName(<span class="literal">"length"</span>);
		<span class="reserved">this</span>.length = t.value.toSigned();
	}
}



<span class="comment">/**
 * Gets the absolute in the OCF format.
 *
 * <span class="attrib">@param</span> {String} df the current directory
 * <span class="attrib">@return</span> the path in OCF encoding
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_Path.<span class="reserved">prototype</span>.getAbsolutePath = <span class="reserved">function</span>(df) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.aid) {
		<span class="reserved">return</span> <span class="reserved">this</span>.aid + <span class="reserved">this</span>.efidOrPath;
	}

	var p = <span class="reserved">this</span>.efidOrPath;
	<span class="reserved">if</span> (p.slice(0, 5) != <span class="literal">":3F00"</span>) {
		p = df + p;
	}

	<span class="reserved">return</span> p;
}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_Path.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"{"</span>;

	<span class="reserved">if</span> (<span class="reserved">this</span>.efidOrPath) {
		str += <span class="literal">"efidOrPath="</span> + <span class="reserved">this</span>.efidOrPath;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.index) {
		str += <span class="literal">",index="</span> + <span class="reserved">this</span>.index;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.length) {
		str += <span class="literal">",length="</span> + <span class="reserved">this</span>.length;
	}
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Creates a CIO DDO object from data usually stored in EF_DIR.
 *
 * <span class="attrib">@class</span> &lt;p&gt;Class to decode CIO DDO objects.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CIODDO ::= SEQUENCE {
 * 		providerId OBJECT IDENTIFIER OPTIONAL,
 * 		odfPath Path OPTIONAL,
 *		ciaInfoPath [0] Path OPTIONAL,
 *		aid [APPLICATION 15] OCTET STRING (SIZE(1..16)),
 *		(CONSTRAINED BY {-- Must be an AID in accordance with ISO/IEC 7816-4--})
 *		OPTIONAL,
 *		... -- For future extensions
 * } -- Context tag 1 is historical and shall not be used
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO DDO
 */</span>
<span class="reserved">function</span> PKCS15_CIODDO(tlv) {
	assert(tlv.tag == 0x73);

	var i = 0;

	<span class="reserved">if</span> (i &lt; tlv.elements) {
		var t = tlv.get(i);
		<span class="reserved">if</span> (t.tag == ASN1.OBJECT_IDENTIFIER) {
			<span class="reserved">this</span>.providerId = t.toString();
			i++;
		}
	}
	
	<span class="reserved">if</span> (i &lt; tlv.elements) {
		var t = tlv.get(i);
		<span class="reserved">if</span> (t.tag == ASN1.SEQUENCE) {
			<span class="reserved">this</span>.odfPath = new PKCS15_Path(t);
			i++;
		}
	}

	<span class="reserved">if</span> (i &lt; tlv.elements) {
		var t = tlv.get(i);
		<span class="reserved">if</span> (t.tag == 0xA0) {
			<span class="reserved">this</span>.ciaInfoPath = new PKCS15_Path(t);
			i++;
		}
	}
}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CIODDO.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"{"</span>;

	<span class="reserved">if</span> (<span class="reserved">this</span>.providerId) {
		str += <span class="literal">"providerId="</span> + <span class="reserved">this</span>.providerId + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.odfPath) {
		str += <span class="literal">"odfPath="</span> + <span class="reserved">this</span>.odfPath + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.ciaInfoPath) {
		str += <span class="literal">"ciaInfoPath="</span> + <span class="reserved">this</span>.ciaInfoPath + <span class="literal">",\n"</span>;
	}
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Creates a structure to access an application template from EF_DIR.
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class provides for access to an application template.&lt;/p&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO DDO
 */</span>
<span class="reserved">function</span> PKCS15_ApplicationTemplate(tlv) {
	assert(tlv.tag == 0x61);
	assert(tlv.elements &gt; 0);
	
	<span class="reserved">for</span> (var i = 0; i &lt; tlv.elements; i++) {
		var t = tlv.get(i);
		switch(t.tag) {
			case 0x4F:
				<span class="reserved">this</span>.aid = t.value.toString(HEX);
				break;
			case 0x50:
				<span class="reserved">this</span>.label = t.value.toString(UTF8);
				break;
			case 0x51:
				<span class="reserved">this</span>.path = <span class="literal">":"</span> + t.value.toString(HEX);
				break;
			case 0x73:
				<span class="reserved">this</span>.ddo = new PKCS15_CIODDO(t);
				break;
		}
	}
}

<span class="comment">/**
 * The application identifier for this application.
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_ApplicationTemplate.<span class="reserved">prototype</span>.aid = <span class="literal">""</span>;

<span class="comment">/**
 * The application label for this application.
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_ApplicationTemplate.<span class="reserved">prototype</span>.label = <span class="literal">""</span>;

<span class="comment">/**
 * The path for this application.
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_ApplicationTemplate.<span class="reserved">prototype</span>.path = <span class="literal">""</span>;

<span class="comment">/**
 * The PKCS#15 Directory Data Object (DDO) for this application.
 * <span class="attrib">@type</span> PKCS15_CIODDO
 */</span>
PKCS15_ApplicationTemplate.<span class="reserved">prototype</span>.ddo = <span class="literal">""</span>;

<span class="comment">/**
 * The list of Cryptographic Information Objects (CIO).
 * <span class="attrib">@see</span> PKCS15.readObjectListForApplication
 * <span class="attrib">@type</span> PKCS15_CIO[]
 */</span>
PKCS15_ApplicationTemplate.<span class="reserved">prototype</span>.objlist = null;



<span class="comment">/**
 * Convert the object to a human readable string
 */</span>
PKCS15_ApplicationTemplate.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"{"</span>;

	<span class="reserved">if</span> (<span class="reserved">this</span>.aid) {
		str += <span class="literal">"aid="</span> + <span class="reserved">this</span>.aid + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.label) {
		str += <span class="literal">"label="</span> + <span class="reserved">this</span>.label + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.path) {
		str += <span class="literal">"path="</span> + <span class="reserved">this</span>.path + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (<span class="reserved">this</span>.ddo) {
		str += <span class="literal">"ddo="</span> + <span class="reserved">this</span>.ddo + <span class="literal">",\n"</span>;
	}
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Creates a CIAInfo object.
 *
 * <span class="attrib">@class</span> &lt;p&gt;Class to decode CIAInfo objects.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CIAInfo ::= SEQUENCE {
 *		version INTEGER {v1(0),v2(1)} (v1|v2,...),
 *		serialNumber OCTET STRING OPTIONAL,
 *		manufacturerID Label OPTIONAL,
 *		label [0] Label OPTIONAL,
 *		cardflags CardFlags,
 *		seInfo SEQUENCE OF SecurityEnvironmentInfo OPTIONAL,
 *		recordInfo [1] RecordInfo OPTIONAL,
 *		supportedAlgorithms [2] SEQUENCE OF AlgorithmInfo OPTIONAL,
 *		issuerId [3] Label OPTIONAL,
 *		holderId [4] Label OPTIONAL,
 *		lastUpdate [5] LastUpdate OPTIONAL,
 *		preferredLanguage PrintableString OPTIONAL, -- In accordance with IETF RFC 1766
 *		profileIndication [6] SEQUENCE OF ProfileIndication OPTIONAL,
 *		...
 *		} (CONSTRAINED BY { -- Each AlgorithmInfo.reference value shall be unique --})
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIAInfo
 */</span>
<span class="reserved">function</span> PKCS15_CIAInfo(tlv) {
	assert(tlv.tag == ASN1.SEQUENCE);
	assert(tlv.elements &gt; 2);

	<span class="reserved">this</span>.tlv = tlv;
	var i = 0;
	var t;

	tlv.setName(<span class="literal">"CIAInfo"</span>);
	
	<span class="comment">// version</span>
	t = tlv.get(i);
	assert(t.tag == ASN1.INTEGER);
	t.setName(<span class="literal">"version"</span>);
	<span class="reserved">this</span>.version = t.value.toSigned();
	i++;

	<span class="comment">// serialNumber	</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.OCTET_STRING)) {
		t.setName(<span class="literal">"serialNumber"</span>);
		<span class="reserved">this</span>.serialNumber = t.value;
		i++;
	}
	
	<span class="comment">// manufacturerID</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.UTF8String)) {
		t.setName(<span class="literal">"manufacturerID"</span>);
		<span class="reserved">this</span>.manufacturerID = t.value.toString(UTF8);
		i++;
	}
	
	<span class="comment">// label</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0x80)) {
		t.setName(<span class="literal">"label"</span>);
		<span class="reserved">this</span>.label = t.value.toString(UTF8);
		i++;
	}

	t = tlv.get(i);
	assert(t.tag == ASN1.BIT_STRING);
	<span class="reserved">if</span> (t.length &gt; 1) {
		<span class="reserved">this</span>.cardflags = t.value.bytes(1,1).toUnsigned();
		t.setName(<span class="literal">"cardflags {"</span> + <span class="reserved">this</span>.getCardflagsAsString() + <span class="literal">" }"</span>);
	} <span class="reserved">else</span> {
		<span class="reserved">this</span>.cardflags = 0;
	}
	i++;

	<span class="comment">// seInfo SEQUENCE OF SecurityEnvironmentInfo OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.SEQUENCE)) {
		t.setName(<span class="literal">"seInfo"</span>);
		print(<span class="literal">"CIAInfo.seInfo not further decoded : "</span> + t);
		<span class="reserved">this</span>.seInfo = <span class="literal">"### not implemented ###"</span>;
		i++;
	}

	<span class="comment">// recordInfo [1] RecordInfo OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA1)) {
		t.setName(<span class="literal">"recordInfo"</span>);
		print(<span class="literal">"CIAInfo.recordInfo not further decoded : "</span> + t);
		<span class="reserved">this</span>.recordInfo = <span class="literal">"### not implemented ###"</span>;
		i++;
	}

	<span class="comment">// supportedAlgorithms [2] SEQUENCE OF AlgorithmInfo OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA2)) {
		t.setName(<span class="literal">"supportedAlgorithms"</span>);
		<span class="reserved">this</span>.supportedAlgorithms = new Array();
		<span class="reserved">for</span> (var j = 0; j &lt; t.elements; j++) {
			var alg = new AlgorithmInfo(t.get(j));
			<span class="reserved">this</span>.supportedAlgorithms.push(alg);
		}
		i++;
	}

	<span class="comment">// issuerId [3] Label OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA3)) {
		t.setName(<span class="literal">"issuerId"</span>);
		print(<span class="literal">"CIAInfo.issuerId not further decoded : "</span> + t);
		<span class="reserved">this</span>.issuerId = <span class="literal">"### not implemented ###"</span>;
		i++;
	}

	<span class="comment">// holderId [4] Label OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA4)) {
		t.setName(<span class="literal">"holderId"</span>);
		print(<span class="literal">"CIAInfo.holderId not further decoded : "</span> + t);
		<span class="reserved">this</span>.holderId = <span class="literal">"### not implemented ###"</span>;
		i++;
	}

	<span class="comment">// lastUpdate [5] LastUpdate OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA5)) {
		t.setName(<span class="literal">"lastUpdate"</span>);
		print(<span class="literal">"CIAInfo.lastUpdate not further decoded : "</span> + t);
		<span class="reserved">this</span>.lastUpdate = <span class="literal">"### not implemented ###"</span>;
		i++;
	}

	<span class="comment">// preferredLanguage PrintableString OPTIONAL, -- In accordance with IETF RFC 1766</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.PrintableString)) {
		t.setName(<span class="literal">"preferredLanguage"</span>);
		<span class="reserved">this</span>.preferredLanguage = t.value.toString(ASCII);
		i++;
	}

	<span class="comment">// profileIndication [6] SEQUENCE OF ProfileIndication OPTIONAL,</span>
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA6)) {
		t.setName(<span class="literal">"profileIndicator"</span>);
		print(<span class="literal">"CIAInfo.profileIndicator not further decoded : "</span> + t);
		<span class="reserved">this</span>.profileIndication = <span class="literal">"### not implemented ###"</span>;
		i++;
	}
}



<span class="comment">/**
 * Gets the card flags as string of concatenated flags.
 * <span class="attrib">@return</span> the string containing the flags separated by a blank
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CIAInfo.<span class="reserved">prototype</span>.getCardflagsAsString = <span class="reserved">function</span>() {
	<span class="reserved">return</span> (<span class="reserved">this</span>.cardflags &amp; 0x80 ? <span class="literal">" readonly"</span> : <span class="literal">""</span>) +
	       (<span class="reserved">this</span>.cardflags &amp; 0x40 ? <span class="literal">" authRequired"</span> : <span class="literal">""</span>) +
	       (<span class="reserved">this</span>.cardflags &amp; 0x20 ? <span class="literal">" prnGeneration"</span> : <span class="literal">""</span>);
}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CIAInfo.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"CIAInfo { "</span>;

	str += <span class="literal">"version="</span> + <span class="reserved">this</span>.version + <span class="literal">",\n"</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.serialNumber) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"serialNumber="</span> + <span class="reserved">this</span>.serialNumber + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.manufacturerID) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"manufacturerID="</span> + <span class="reserved">this</span>.manufacturerID + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.label) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"label="</span> + <span class="reserved">this</span>.label + <span class="literal">",\n"</span>;
	}

	str += <span class="literal">"cardflags="</span> + <span class="reserved">this</span>.getCardflagsAsString() + <span class="literal">",\n"</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.supportedAlgorithms) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"supportedAlgorithms={\n"</span>; 
		<span class="reserved">for</span> (var i = 0; i &lt; <span class="reserved">this</span>.supportedAlgorithms.length; i++) {
			str += <span class="reserved">this</span>.supportedAlgorithms[i].toString() + <span class="literal">"\n"</span>;
		}
		str += <span class="literal">"},\n"</span>; 
	}
	
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.preferredLanguage) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"preferredLanguage="</span> + <span class="reserved">this</span>.preferredLanguage + <span class="literal">",\n"</span>;
	}

	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create an AlgorithmInfo object from TLV data
 *
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * AlgorithmInfo ::= SEQUENCE {
 *   reference Reference,
 *   algorithm CIO-ALGORITHM.&amp;id({AlgorithmSet}),
 *   parameters CIO-ALGORITHM.&amp;Parameters({AlgorithmSet}{<span class="attrib">@algorithm</span>}),
 *   supportedOperations CIO-ALGORITHM.&amp;Operations({AlgorithmSet}{<span class="attrib">@algorithm</span>}),
 *   objId CIO-ALGORITHM.&amp;objectIdentifier ({AlgorithmSet}{<span class="attrib">@algorithm</span>}),
 *   algRef Reference OPTIONAL
 * }
 *
 * CIO-ALGORITHM ::= CLASS {
 *   &amp;id INTEGER UNIQUE,
 *   &amp;Parameters,
 *   &amp;Operations Operations,
 *   &amp;objectIdentifier OBJECT IDENTIFIER OPTIONAL
 *   } WITH SYNTAX {
 *   PARAMETERS &amp;Parameters OPERATIONS &amp;Operations ID &amp;id [OID &amp;objectIdentifier]
 * }
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the AlgorithmInfo
 */</span>
<span class="reserved">function</span> AlgorithmInfo(tlv) {
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		assert(tlv.isconstructed);
		assert(tlv.elements &gt;= 5);
		
		<span class="reserved">this</span>.tlv = tlv;

		var i = 0;
		var t;
		
		assert((t = tlv.get(i)).tag == ASN1.INTEGER);
		t.setName(<span class="literal">"reference"</span>);
		<span class="reserved">this</span>.reference = t.value.toSigned();
		i++;
		
		assert((t = tlv.get(i)).tag == ASN1.INTEGER);
		t.setName(<span class="literal">"algorithm"</span>);
		<span class="reserved">this</span>.algorithm = t.value.toSigned();
		i++;
		
		t = tlv.get(i);
		t.setName(<span class="literal">"parameters"</span>);
		<span class="reserved">this</span>.parameters = t;
		i++;

		assert((t = tlv.get(i)).tag == ASN1.BIT_STRING);
		<span class="reserved">this</span>.supportedOperations = t.value.bytes(1,1).toUnsigned();
		t.setName(<span class="literal">"supportedOperations {"</span> + <span class="reserved">this</span>.getOperationsAsString() + <span class="literal">" }"</span>);
		i++;

		<span class="reserved">if</span> (i &lt; tlv.elements) {
			assert((t = tlv.get(i)).tag == ASN1.OBJECT_IDENTIFIER);
			t.setName(<span class="literal">"objId"</span>);
			<span class="reserved">this</span>.objId = t.value.toString(OID);
			i++;
		}

		<span class="reserved">if</span> (i &lt; tlv.elements) {
			assert((t = tlv.get(i)).tag == ASN1.INTEGER);
			t.setName(<span class="literal">"algRef"</span>);
			<span class="reserved">this</span>.algRef = t.value.toSigned();
			i++;
		}
	}
}



<span class="comment">/**
 * Gets the operations flags as string of concatenated tokens.
 * <span class="attrib">@return</span> the string containing the flags separated by a blank
 * <span class="attrib">@type</span> String
 */</span>
AlgorithmInfo.<span class="reserved">prototype</span>.getOperationsAsString = <span class="reserved">function</span>() {
	<span class="reserved">return</span> (<span class="reserved">this</span>.supportedOperations &amp; 0x80 ? <span class="literal">" compute-checksum"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x40 ? <span class="literal">" compute-signature"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x20 ? <span class="literal">" verify-checksum"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x10 ? <span class="literal">" verify-signature"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x08 ? <span class="literal">" encipher"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x04 ? <span class="literal">" decipher"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x02 ? <span class="literal">" hash"</span> : <span class="literal">""</span>) +
           (<span class="reserved">this</span>.supportedOperations &amp; 0x01 ? <span class="literal">" generate-key"</span> : <span class="literal">""</span>);

}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
AlgorithmInfo.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"AlgorithmInfo { "</span>;
		
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.reference) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"reference="</span> + <span class="reserved">this</span>.reference + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.algorithm) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"algorithm=0x"</span> + <span class="reserved">this</span>.algorithm.toString(16) + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.parameters) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"parameters="</span> + <span class="reserved">this</span>.parameters + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.supportedOperations) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"supportedOperations="</span> + <span class="reserved">this</span>.getOperationsAsString() + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.objId) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"objId="</span> + <span class="reserved">this</span>.objId + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.algRef) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"algRef="</span> + <span class="reserved">this</span>.algRef + <span class="literal">",\n"</span>;
	}

	str += <span class="literal">"}"</span>;
	
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create a Cryptographic Information Object (CIO)
 *
 * <span class="attrib">@class</span> &lt;p&gt;This is the base class for all cryptographic objects in a PKCS#15 data structure.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CommonObjectAttributes ::= SEQUENCE {
 *		label Label OPTIONAL,
 *		flags CommonObjectFlags OPTIONAL,
 *		authId Identifier OPTIONAL,
 *		userConsent INTEGER (1..cia-ub-userConsent) OPTIONAL,
 *		accessControlRules SEQUENCE SIZE (1..MAX) OF AccessControlRule OPTIONAL,
 *		...
 *	} (CONSTRAINED BY {-- authId should be present if flags.private is set.
 *	-- It shall equal an authID in one authentication object in the AOD -- })
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 */</span>
<span class="reserved">function</span> PKCS15_CIO(tlv) {
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		assert(tlv.isconstructed);
		assert(tlv.elements &gt;= 3);
		
		<span class="reserved">this</span>.tlv = tlv;

		var coa = tlv.get(0);
		assert(coa.tag == ASN1.SEQUENCE);

		coa.setName(<span class="literal">"commonObjectAttributes"</span>);
		var i = 0;
		var t;
		
		<span class="reserved">if</span> ((i &lt; coa.elements) &amp;&amp; ((t = coa.get(i)).tag == ASN1.UTF8String)) {
			t.setName(<span class="literal">"label"</span>);
			<span class="reserved">this</span>.label = t.value.toString(UTF8);
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; coa.elements) &amp;&amp; ((t = coa.get(i)).tag == ASN1.BIT_STRING)) {
			<span class="reserved">this</span>.flags = t.value.bytes(1,1).toUnsigned();
			t.setName(<span class="literal">"flags {"</span> + <span class="reserved">this</span>.getFlagsAsString() + <span class="literal">" }"</span>);
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; coa.elements) &amp;&amp; ((t = coa.get(i)).tag == ASN1.OCTET_STRING)) {
			t.setName(<span class="literal">"authId"</span>);
			<span class="reserved">this</span>.authId = t.value;
			i++;
		}

		<span class="reserved">if</span> ((i &lt; coa.elements) &amp;&amp; ((t = coa.get(i)).tag == ASN1.INTEGER)) {
			t.setName(<span class="literal">"userConsent"</span>);
			<span class="reserved">this</span>.userConsent = t.value.toSigned();
			i++;
		}

		<span class="reserved">if</span> ((i &lt; coa.elements) &amp;&amp; ((t = coa.get(i)).tag == ASN1.SEQUENCE)) {
			t.setName(<span class="literal">"accessControlRules"</span>);
			<span class="reserved">this</span>.accessControlRules = t.value;
			i++;
		}
	}
}



<span class="comment">/**
 * Gets the common object flags as string of concatenated flags.
 * <span class="attrib">@return</span> the string containing the flags separated by a blank
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CIO.<span class="reserved">prototype</span>.getFlagsAsString = <span class="reserved">function</span>() {
	<span class="reserved">return</span>  (<span class="reserved">this</span>.flags &amp; 0x80 ? <span class="literal">" private"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.flags &amp; 0x40 ? <span class="literal">" modifiable"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.flags &amp; 0x20 ? <span class="literal">" internal"</span> : <span class="literal">""</span>);
}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CIO.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"CommonObjectAttributes { "</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.label) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"label="</span> + <span class="reserved">this</span>.label + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.flags) != <span class="literal">"undefined"</span>) {	
		str += <span class="literal">"flags="</span> + <span class="reserved">this</span>.getFlagsAsString() + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.authId) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"authId="</span> + <span class="reserved">this</span>.authId + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.userConsent) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"userConsent="</span> + <span class="reserved">this</span>.userConsent + <span class="literal">",\n"</span>;
	}
				
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.accessControlRules) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"accessControlRules="</span> + <span class="reserved">this</span>.accessControlRules + <span class="literal">",\n"</span>;
	}
				
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create a Common Key Attribute Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds common key attributes to the base CIO class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CommonKeyAttributes ::= SEQUENCE {
 *		iD Identifier,
 *		usage KeyUsageFlags,
 *		native BOOLEAN DEFAULT TRUE,
 *		accessFlags KeyAccessFlags OPTIONAL,
 *		keyReference KeyReference OPTIONAL,
 *		startDate GeneralizedTime OPTIONAL,
 *		endDate [0] GeneralizedTime OPTIONAL,
 *		algReference [1] SEQUENCE OF Reference OPTIONAL,
 *		... -- For future extensions
 *		}
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CIO PKCS15_CIO is the base class
 */</span>
<span class="reserved">function</span> PKCS15_CommonKeyAttributes(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CIO.call(<span class="reserved">this</span>, tlv);

	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		tlv = tlv.get(1);
		tlv.setName(<span class="literal">"commonKeyAttributes"</span>);		
		var i = 0;
		var t;
		
		assert((t = tlv.get(i)).tag == ASN1.OCTET_STRING);
		t.setName(<span class="literal">"iD"</span>);
		<span class="reserved">this</span>.iD = t.value;
		i++;

		assert((t = tlv.get(i)).tag == ASN1.BIT_STRING);
		<span class="reserved">this</span>.usage = t.value.bytes(1).toUnsigned(true);
		t.setName(<span class="literal">"usage {"</span> + <span class="reserved">this</span>.getUsageAsString() + <span class="literal">" }"</span>);
		i++;
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.BOOLEAN)) {
			t.setName(<span class="literal">"native"</span>);
			<span class="reserved">this</span>.native_ = t.value.toUnsigned();
			i++;
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.native_ = true;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.BIT_STRING)) {
			<span class="reserved">this</span>.accessFlags = t.value.bytes(1).toUnsigned(true);
			t.setName(<span class="literal">"accessFlags {"</span> + <span class="reserved">this</span>.getAccessFlagsAsString() + <span class="literal">" }"</span>);
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.INTEGER)) {
			t.setName(<span class="literal">"keyReference"</span>);
			<span class="reserved">this</span>.keyReference = t.value.toSigned();
			i++;
		}

		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.GeneralizedTime)) {
			t.setName(<span class="literal">"startDate"</span>);
			<span class="reserved">this</span>.startDate = t.getDate();
			i++;
		}

		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0x80)) {
			t.setName(<span class="literal">"endDate"</span>);
			<span class="reserved">this</span>.endDate = t.getDate();
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA1)) {
			assert(t.isconstructed);
			t.setName(<span class="literal">"algReference"</span>);
			<span class="reserved">this</span>.algReference = new Array();
			<span class="reserved">for</span> (var j = 0; j &lt; t.elements; j++) {
				assert(t.get(j).tag == ASN1.INTEGER);
				t.get(j).setName(<span class="literal">"reference"</span>);
				<span class="reserved">this</span>.algReference.push(t.get(j).value.toSigned());
			}
			i++;
		}
	}
}

PKCS15_CommonKeyAttributes.<span class="reserved">prototype</span> = new PKCS15_CIO();



<span class="comment">/**
 * Gets the key usage flags as string of concatenated flags.
 * <span class="attrib">@return</span> the string containing the flags separated by a blank
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CommonKeyAttributes.<span class="reserved">prototype</span>.getUsageAsString = <span class="reserved">function</span>() {
	<span class="reserved">return</span>  (<span class="reserved">this</span>.usage &amp; 0x0080 ? <span class="literal">" encipher"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0040 ? <span class="literal">" decipher"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0020 ? <span class="literal">" sign"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0010 ? <span class="literal">" signRecover"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0008 ? <span class="literal">" keyEncipher"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0004 ? <span class="literal">" keyDecipher"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0002 ? <span class="literal">" verify"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x0001 ? <span class="literal">" verifyRecover"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x8000 ? <span class="literal">" derive"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.usage &amp; 0x4000 ? <span class="literal">" nonRepudiation"</span> : <span class="literal">""</span>);
}



<span class="comment">/**
 * Gets the key access flags as string of concatenated flags.
 * <span class="attrib">@return</span> the string containing the flags separated by a blank
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CommonKeyAttributes.<span class="reserved">prototype</span>.getAccessFlagsAsString = <span class="reserved">function</span>() {
	<span class="reserved">return</span>	(<span class="reserved">this</span>.accessFlags &amp; 0x80 ? <span class="literal">" sensitive"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.accessFlags &amp; 0x40 ? <span class="literal">" extractable"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.accessFlags &amp; 0x20 ? <span class="literal">" alwaysSensitive"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.accessFlags &amp; 0x10 ? <span class="literal">" neverExtractable"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.accessFlags &amp; 0x08 ? <span class="literal">" cardGenerated"</span> : <span class="literal">""</span>);
}



<span class="comment">/**
 * Convert the object to a human readable string
 * <span class="attrib">@return</span> content information
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CommonKeyAttributes.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {

	var str = PKCS15_CIO.<span class="reserved">prototype</span>.toString.call(<span class="reserved">this</span>);
	str += <span class="literal">"\nCommonKeyAttributes { "</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.iD) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"iD="</span> + <span class="reserved">this</span>.iD + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.usage) != <span class="literal">"undefined"</span>) {	
		str += <span class="literal">"usage="</span> + <span class="reserved">this</span>.getUsageAsString() + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.native_) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"native="</span> + <span class="reserved">this</span>.native_ + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.accessFlags) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"accessFlags="</span> + <span class="reserved">this</span>.getAccessFlagsAsString() + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.keyReference) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"keyReference="</span> + <span class="reserved">this</span>.keyReference + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.startDate) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"startDate="</span> + <span class="reserved">this</span>.startDate + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.endDate) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"endDate="</span> + <span class="reserved">this</span>.endDate + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.algReference) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"algReference="</span> + <span class="reserved">this</span>.algReference + <span class="literal">",\n"</span>;
	}
	
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create a Common Private Key Attribute Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds common private key attributes to the common key attribute class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CommonPrivateKeyAttributes ::= SEQUENCE {
 * name Name OPTIONAL,
 * keyIdentifiers [0] SEQUENCE OF CredentialIdentifier {{KeyIdentifiers}} OPTIONAL,
 * generalName [1] GeneralNames OPTIONAL,
 * ... -- For future extensions
 * }
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CommonKeyAttributes PKCS15_CommonKeyAttributes is the base class
 */</span>
<span class="reserved">function</span> PKCS15_CommonPrivateKeyAttributes(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CommonKeyAttributes.call(<span class="reserved">this</span>, tlv);

	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		var t = tlv.get(2);
		<span class="reserved">if</span> (t.tag == 0xA0) {
			t.setName(<span class="literal">"subClassAttributes"</span>);

			assert(t.elements == 1);
			t = t.get(0);
			t.setName(<span class="literal">"commonPrivateKeyAttributes"</span>);
			
			var i = 0;
			<span class="reserved">if</span> (t.elements &gt; i) {
				print(<span class="literal">"### Not decoded ### "</span> + t);
			}
		}
	}
}

PKCS15_CommonPrivateKeyAttributes.<span class="reserved">prototype</span> = new PKCS15_CommonKeyAttributes();



<span class="comment">/**
 * Create a Private Key Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds private key attributes to the common private key attribute class.&lt;/p&gt;
 * &lt;p&gt;The class supports RSA and ECC keys.&lt;/p&gt;
 * &lt;p&gt;RSA keys are decoded from the following ASN.1 structure:&lt;/p&gt;
 * &lt;pre&gt;
 * PrivateRSAKeyAttributes ::= SEQUENCE {
 * value Path,
 * modulusLength INTEGER, -- modulus length in bits, e.g. 1024
 * keyInfo KeyInfo {NULL, PublicKeyOperations} OPTIONAL,
 * ... -- For future extensions
 * }
 * &lt;/pre&gt;
 * &lt;p&gt;ECC keys are decoded from the following ASN.1 structure:&lt;/p&gt;
 * &lt;pre&gt;
 * PrivateECKeyAttributes ::= SEQUENCE {
 * value Path,
 * keyInfo KeyInfo {Parameters, PublicKeyOperations} OPTIONAL,
 * ... -- For future extensions
 * }
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CommonPrivateKeyAttributes PKCS15_CommonPrivateKeyAttributes is the base class
 */</span>
<span class="reserved">function</span> PKCS15_PrivateKey(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CommonPrivateKeyAttributes.call(<span class="reserved">this</span>, tlv);
	
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		var t = tlv.get(tlv.elements - 1);

		assert(t.tag == 0xA1);
		assert(t.elements &gt;= 1);
		t.setName(<span class="literal">"typeAttributes"</span>);
		
		t = t.get(0);
		
		switch(tlv.tag) {
		case 0x30: <span class="reserved">this</span>.decodePrivateRSAKey(t); break;
		case 0xA0: <span class="reserved">this</span>.decodePrivateECCKey(t); break;
		default: 
			<span class="reserved">this</span>.type = <span class="literal">"PrivateKey"</span>; break;
			print(<span class="literal">"### Not decoded ### "</span> + t);
		}
	}
}

PKCS15_PrivateKey.<span class="reserved">prototype</span> = new PKCS15_CommonPrivateKeyAttributes();



<span class="comment">/**
 * Decodes the RSA key structure.
 *
 * <span class="attrib">@private</span>
 * <span class="attrib">@param</span> {ASN1} tlv the TLV structure
 */</span>
PKCS15_PrivateKey.<span class="reserved">prototype</span>.decodePrivateRSAKey = <span class="reserved">function</span>(tlv) {
	<span class="reserved">this</span>.type = <span class="literal">"PrivateRSAKey"</span>; 
	tlv.setName(<span class="literal">"privateRSAKeyAttributes"</span>);

	var t = tlv.get(0);
	<span class="reserved">this</span>.value = new PKCS15_Path(t);
	t.setName(<span class="literal">"value"</span>);
	
	t = tlv.get(1);
	assert(t.tag == ASN1.INTEGER);
	<span class="reserved">this</span>.modulusLength = t.value.toSigned();
	t.setName(<span class="literal">"modulusLength"</span>);
	
	<span class="reserved">if</span> (tlv.elements &gt; 2) {
		t = tlv.get(2);
		<span class="reserved">if</span> (t.tag == ASN1.INTEGER) {
			t.setName(<span class="literal">"reference"</span>);
		} <span class="reserved">else</span> {
			t.setName(<span class="literal">"paramsAndOps"</span>);
		}
	}
}



<span class="comment">/**
 * Decodes the ECC key structure.
 *
 * <span class="attrib">@private</span>
 * <span class="attrib">@param</span> {ASN1} tlv the TLV structure
 */</span>
PKCS15_PrivateKey.<span class="reserved">prototype</span>.decodePrivateECCKey = <span class="reserved">function</span>(tlv) {
	<span class="reserved">this</span>.type = <span class="literal">"PrivateECCKey"</span>; 
	tlv.setName(<span class="literal">"privateECCKeyAttributes"</span>);
	
	var t = tlv.get(0);
	<span class="reserved">this</span>.value = new PKCS15_Path(t);
	t.setName(<span class="literal">"value"</span>);
	
	<span class="reserved">if</span> (tlv.elements &gt; 1) {
		t = tlv.get(1);
		<span class="reserved">if</span> (t.tag == ASN1.INTEGER) {
			t.setName(<span class="literal">"reference"</span>);
		} <span class="reserved">else</span> {
			t.setName(<span class="literal">"paramsAndOps"</span>);
		}
	}
}



<span class="comment">/**
 * Create a Common Certificate Attribute Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds common certificate attributes to the base CIO class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CommonCertificateAttributes ::= SEQUENCE {
 * iD Identifier,
 * authority BOOLEAN DEFAULT FALSE,
 * identifier CredentialIdentifier {{KeyIdentifiers}} OPTIONAL,
 * certHash [0] CertHash OPTIONAL,
 * trustedUsage [1] Usage OPTIONAL,
 * identifiers [2] SEQUENCE OF CredentialIdentifier {{KeyIdentifiers}} OPTIONAL,
 * validity [4] Validity OPTIONAL,
 * ...
 * } -- Context tag [3] is reserved for historical reasons
 * NOTE PKCS #15 uses context tag [3].
 * Usage ::= SEQUENCE {
 * keyUsage KeyUsage OPTIONAL,
 * extKeyUsage SEQUENCE SIZE (1..MAX) OF OBJECT IDENTIFIER OPTIONAL,
 * ...
 * } (WITH COMPONENTS {..., keyUsage PRESENT} | WITH COMPONENTS {..., extKeyUsage PRESENT})
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CIO PKCS15_CIO is the base class
 */</span>
<span class="reserved">function</span> PKCS15_CommonCertificateAttributes(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CIO.call(<span class="reserved">this</span>, tlv);
	
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		var tlv = tlv.get(1);
		tlv.setName(<span class="literal">"commonCertificateAttributes"</span>);
		var i = 0;
		var t;
		
		assert((t = tlv.get(i)).tag == ASN1.OCTET_STRING);
		t.setName(<span class="literal">"iD"</span>);
		<span class="reserved">this</span>.iD = t.value;
		i++;
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.BOOLEAN)) {
			t.setName(<span class="literal">"authority"</span>);
			<span class="reserved">this</span>.authority = (t.value.toUnsigned() &gt; 0);
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.SEQUENCE)) {
			t.setName(<span class="literal">"identifier"</span>);
			<span class="reserved">this</span>.identifier = t.value;
			i++;
		}
		
		<span class="comment">// Uncommon fields missing</span>
	}
}

PKCS15_CommonCertificateAttributes.<span class="reserved">prototype</span> = new PKCS15_CIO();



<span class="comment">/**
 * Convert the object to a human readable string
 * <span class="attrib">@return</span> content information
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CommonCertificateAttributes.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = PKCS15_CIO.<span class="reserved">prototype</span>.toString.call(<span class="reserved">this</span>);
	str += <span class="literal">"\nCommonCertificateAttributes { "</span>;

	str += <span class="literal">"iD="</span> + <span class="reserved">this</span>.iD + <span class="literal">",\n"</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.authority) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"authority="</span> + <span class="reserved">this</span>.authority + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.identifier) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"identifier="</span> + <span class="reserved">this</span>.identifier + <span class="literal">",\n"</span>;
	}
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create a Certificate Attribute Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds X.509 certificate attributes to the common certificate attribute class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax for X.509 certificates:&lt;/p&gt;
 * &lt;pre&gt;
 * X509CertificateAttributes ::= SEQUENCE {
 * value ObjectValue { Certificate },
 * subject Name OPTIONAL,
 * issuer [0] Name OPTIONAL,
 * serialNumber CertificateSerialNumber OPTIONAL,
 * ... -- For future extensions
 * }
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CommonCertificateAttributes PKCS15_CommonCertificateAttributes is the base class
 */</span>
<span class="reserved">function</span> PKCS15_Certificate(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CommonCertificateAttributes.call(<span class="reserved">this</span>, tlv);

	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		
		var t = tlv.get(2);
		assert(t.tag == 0xA1);
		assert(t.elements == 1);
		t.setName(<span class="literal">"typeAttributes"</span>);
		t = t.get(0);
		t.setName(<span class="literal">"certificateAttributes"</span>);
		
		switch(tlv.tag) {
		case 0x30: <span class="reserved">this</span>.decodeX509Certificate(t); break;
		default: 
			<span class="reserved">this</span>.type = <span class="literal">"Certificate"</span>; break;
			print(<span class="literal">"### Not decoded ### "</span> + t);
		}
<span class="comment">//		print("Certificate:" + t);</span>
	}
}

PKCS15_Certificate.<span class="reserved">prototype</span> = new PKCS15_CommonCertificateAttributes();



<span class="comment">/**
 * Decodes a X.509 certificate structure.
 *
 * <span class="attrib">@private</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the certificate data
 */</span>
PKCS15_Certificate.<span class="reserved">prototype</span>.decodeX509Certificate = <span class="reserved">function</span>(tlv) {
	<span class="reserved">this</span>.type = <span class="literal">"X509Certificate"</span>; 
	tlv.setName(<span class="literal">"x509CertificateAttributes"</span>);
	
	var t = tlv.get(0);
	t.setName(<span class="literal">"value"</span>);

	<span class="reserved">if</span> (t.tag == ASN1.SEQUENCE) {	
		<span class="reserved">this</span>.value = new PKCS15_Path(t);
	}

	var i = 1;
	
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.SEQUENCE)) {
		t.setName(<span class="literal">"subject"</span>);
		i++;
	}

	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0xA0)) {
		t.setName(<span class="literal">"issuer"</span>);
		i++;
	}
	
	<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.INTEGER)) {
		t.setName(<span class="literal">"serialNumber"</span>);
		<span class="reserved">this</span>.serialNumber = t.value;
		i++;
	}
}



<span class="comment">/**
 * Create a Common Authentication Object Attribute Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds common authentication object attributes to the base CIO class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CommonAuthenticationObjectAttributes ::= SEQUENCE {
 *    authId Identifier OPTIONAL,
 *    authReference Reference OPTIONAL,
 *    seIdentifier [0] Reference OPTIONAL,
 *    ... -- For future extensions
 * }
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CIO PKCS15_CIO is the base class
 */</span>
<span class="reserved">function</span> PKCS15_CommonAuthenticationObjectAttributes(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CIO.call(<span class="reserved">this</span>, tlv);
	
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		var tlv = tlv.get(1);
		tlv.setName(<span class="literal">"commonAuthenticationObjectAttributes"</span>);
<span class="comment">//		print("CommonAuthenticationObjectAttributes:" + tlv);</span>

		var i = 0;
		var t;

		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.OCTET_STRING)) {
			t.setName(<span class="literal">"authIdThis"</span>);
			<span class="reserved">this</span>.authIdThis = t.value;
			i++;
		}

		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.INTEGER)) {
			t.setName(<span class="literal">"authReference"</span>);
			<span class="reserved">this</span>.authReference = t.value.toSigned();
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0x80)) {
			t.setName(<span class="literal">"seIdentifier"</span>);
			<span class="reserved">this</span>.seIdentifier = t.value.toSigned();
			i++;
		}
	}
}

PKCS15_CommonAuthenticationObjectAttributes.<span class="reserved">prototype</span> = new PKCS15_CIO();



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CommonAuthenticationObjectAttributes.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {

	var str = PKCS15_CIO.<span class="reserved">prototype</span>.toString.call(<span class="reserved">this</span>);
	str += <span class="literal">"\nCommonAuthenticationObjectAttributes { "</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.authIdThis) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"authIdThis="</span> + <span class="reserved">this</span>.authIdThis + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.authReference) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"authReference="</span> + <span class="reserved">this</span>.authReference + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.seIdentifier) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"seIdentifier="</span> + <span class="reserved">this</span>.seIdentifier + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.pwd) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"pwd="</span> + <span class="reserved">this</span>.pwd.toString() + <span class="literal">",\n"</span>;
	}

	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create an Authentication Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds authentication object attributes to the common authentication object class.&lt;/p&gt;
 * &lt;p&gt;The class supports password objects.&lt;/p&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CommonAuthenticationObjectAttributes PKCS15_CommonAuthenticationObjectAttributes is the base class
 */</span>
<span class="reserved">function</span> PKCS15_AuthenticationObject(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CommonAuthenticationObjectAttributes.call(<span class="reserved">this</span>, tlv);
	
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		var t = tlv.get(tlv.elements - 1);
		assert(t.tag == 0xA1);
		assert(t.elements == 1);
		t.setName(<span class="literal">"typeAttribute"</span>);
		t = t.get(0);
		
		switch(t.tag) {
		case 0x30:
			<span class="reserved">this</span>.pwd = new PKCS15_PasswordAuthenticationObject(t);
			break;
		default:
			print(<span class="literal">"### Unsupported authentication object type : "</span> + t);
			break;
		}
	}
}

PKCS15_AuthenticationObject.<span class="reserved">prototype</span> = new PKCS15_CommonAuthenticationObjectAttributes();



<span class="comment">/**
 * Create a Password Authentication Object 
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class supports password authentication objects.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * PasswordAttributes ::= SEQUENCE {
 *	pwdFlags PasswordFlags,
 *	pwdType PasswordType,
 *	minLength INTEGER (cia-lb-minPasswordLength..cia-ub-minPasswordLength),
 *	storedLength INTEGER (0..cia-ub-storedPasswordLength),
 *	maxLength INTEGER OPTIONAL,
 *	pwdReference [0] Reference DEFAULT 0,
 *	padChar OCTET STRING (SIZE(1)) OPTIONAL,
 *	lastPasswordChange GeneralizedTime OPTIONAL,
 *	path Path OPTIONAL,
 *	... -- For future extensions
 * }
 * PasswordFlags ::= BIT STRING {
 *	case-sensitive (0),
 *	local (1),
 *	change-disabled (2),
 *	unblock-disabled (3),
 *	initialized (4),
 *	needs-padding (5),
 *	unblockingPassword (6),
 *	soPassword (7),
 *	disable-allowed (8),
 *	integrity-protected (9),
 *	confidentiality-protected (10),
 *	exchangeRefData (11)
 *	} (CONSTRAINED BY { -- unblockingPassword and soPassword cannot both be set -- })
 * PasswordType ::= ENUMERATED {bcd, ascii-numeric, utf8, half-nibble-bcd, iso9564-1, ...}
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 */</span>
<span class="reserved">function</span> PKCS15_PasswordAuthenticationObject(tlv) {
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
	
		tlv.setName(<span class="literal">"passwordAuthenticationObject"</span>);
		
		var i = 0;
		var t;
		
		assert((t = tlv.get(i)).tag == ASN1.BIT_STRING);
		<span class="reserved">this</span>.pwdFlags = IntFromBitString(t.value);
		t.setName(<span class="literal">"pwdFlags {"</span> + <span class="reserved">this</span>.getPwdFlagsAsString() + <span class="literal">" }"</span>);
		i++;

		assert((t = tlv.get(i)).tag == ASN1.ENUMERATED);
		<span class="reserved">this</span>.pwdType = t.value.toUnsigned();
		t.setName(<span class="literal">"pwdType {"</span> + <span class="reserved">this</span>.getPwdTypeAsString() + <span class="literal">" }"</span>);
		i++;
		
		assert((t = tlv.get(i)).tag == ASN1.INTEGER);
		t.setName(<span class="literal">"minLength"</span>);
		<span class="reserved">this</span>.minLength = t.value.toSigned();
		i++;

		assert((t = tlv.get(i)).tag == ASN1.INTEGER);
		t.setName(<span class="literal">"storedLength"</span>);
		<span class="reserved">this</span>.storedLength = t.value.toSigned();
		i++;

		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.INTEGER)) {
			t.setName(<span class="literal">"maxLength"</span>);
			<span class="reserved">this</span>.maxLength = t.value.toSigned();
			i++;
		}

		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == 0x80)) {
			t.setName(<span class="literal">"pwdReference"</span>);
			<span class="reserved">this</span>.pwdReference = t.value.toSigned();
			i++;
		}
	}
}



<span class="comment">/**
 * Gets the password flags as string of concatenated flags.
 * <span class="attrib">@return</span> the string containing the flags separated by a blank
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_PasswordAuthenticationObject.<span class="reserved">prototype</span>.getPwdFlagsAsString = <span class="reserved">function</span>() {
	<span class="reserved">return</span>	(<span class="reserved">this</span>.pwdFlags &amp; 0x800000 ? <span class="literal">" case-sensitive"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x400000 ? <span class="literal">" local"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x200000 ? <span class="literal">" change-disabled"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x100000 ? <span class="literal">" unblock-disabled"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x080000 ? <span class="literal">" initialized"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x040000 ? <span class="literal">" needs-padding"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x020000 ? <span class="literal">" unblockingPassword"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x010000 ? <span class="literal">" soPassword"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x008000 ? <span class="literal">" disable-allowed"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x004000 ? <span class="literal">" integrity-protected"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x002000 ? <span class="literal">" confidentiality-protected"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x001000 ? <span class="literal">" exchangeRefData"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x000800 ? <span class="literal">" resetRetryCounter1"</span> : <span class="literal">""</span>) +
		(<span class="reserved">this</span>.pwdFlags &amp; 0x000400 ? <span class="literal">" resetRetryCounter2"</span> : <span class="literal">""</span>);
}



<span class="comment">/**
 * Gets the password type.
 * <span class="attrib">@return</span> the string containing the password type (BCD, ASCII-NUMERIC, UTF8, HALF-NIBBLE-BCD or ISO9564-1)
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_PasswordAuthenticationObject.<span class="reserved">prototype</span>.getPwdTypeAsString = <span class="reserved">function</span>() {

	var str = <span class="literal">""</span> + <span class="reserved">this</span>.pwdType;
	switch(<span class="reserved">this</span>.pwdType) {
		case  0 : str = <span class="literal">"BCD"</span>; break;
		case  1 : str = <span class="literal">"ASCII-NUMERIC"</span>; break;
		case  2 : str = <span class="literal">"UTF8"</span>; break;
		case  3 : str = <span class="literal">"HALF-NIBBLE-BCD"</span>; break;
		case  4 : str = <span class="literal">"ISO9564-1"</span>; break;
	}
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_PasswordAuthenticationObject.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
	var str = <span class="literal">"Password { "</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.pwdFlags) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"pwdFlags="</span> + <span class="reserved">this</span>.getPwdFlagsAsString() + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.pwdType) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"pwdType="</span> + <span class="reserved">this</span>.getPwdTypeAsString() + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.minLength) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"minLength="</span> + <span class="reserved">this</span>.minLength + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.storedLength) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"storedLength="</span> + <span class="reserved">this</span>.storedLength + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.maxLength) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"maxLength="</span> + <span class="reserved">this</span>.maxLength + <span class="literal">",\n"</span>;
	}

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.pwdReference) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"pwdReference="</span> + <span class="reserved">this</span>.pwdReference + <span class="literal">",\n"</span>;
	}
	
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create a Common Data Container Object Attribute Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds common data container attributes to the base CIO class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax:&lt;/p&gt;
 * &lt;pre&gt;
 * CommonDataContainerObjectAttributes ::= SEQUENCE {
 * 		applicationName Label OPTIONAL,
 * 		applicationOID OBJECT IDENTIFIER OPTIONAL,
 * 		iD Identifier OPTIONAL,
 * 		... -- For future extensions
 * 		} (WITH COMPONENTS {..., applicationName PRESENT}
 * 		| WITH COMPONENTS {..., applicationOID PRESENT})
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CIO PKCS15_CIO is the base class
 */</span>
<span class="reserved">function</span> PKCS15_CommonDataContainerObjectAttributes(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CIO.call(<span class="reserved">this</span>, tlv);
	
	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		var tlv = tlv.get(1);
		tlv.setName(<span class="literal">"commonDataContainerObjectAttributes"</span>);
		var i = 0;
		var t;
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.UTF8String)) {
			t.setName(<span class="literal">"applicationName"</span>);
			<span class="reserved">this</span>.applicationName = t.value.toString(UTF8);
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.OBJECT_IDENTIFIER)) {
			t.setName(<span class="literal">"applicationOID"</span>);
			<span class="reserved">this</span>.applicationOID = t.value.toString(OID);
			i++;
		}
		
		<span class="reserved">if</span> ((i &lt; tlv.elements) &amp;&amp; ((t = tlv.get(i)).tag == ASN1.ASN1.OCTET_STRING)) {
			t.setName(<span class="literal">"iD"</span>);
			<span class="reserved">this</span>.iD = t.value;
			i++;
		}
	}
}

PKCS15_CommonDataContainerObjectAttributes.<span class="reserved">prototype</span> = new PKCS15_CIO();



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_CommonDataContainerObjectAttributes.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {

	var str = PKCS15_CIO.<span class="reserved">prototype</span>.toString.call(<span class="reserved">this</span>);
	str += <span class="literal">"\nCommonDataContainerObjectAttributes { "</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.applicationName) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"applicationName="</span> + <span class="reserved">this</span>.applicationName + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.applicationOID) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"applicationOID="</span> + <span class="reserved">this</span>.applicationOID + <span class="literal">",\n"</span>;
	}
	
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.iD) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"iD="</span> + <span class="reserved">this</span>.iD + <span class="literal">",\n"</span>;
	}
	
	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create a Data Container Object
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class adds data container objects to the common data container object attributes class.&lt;/p&gt;
 * &lt;p&gt;The class decodes the following ASN.1 syntax for opaque data objects with indirect path reference:&lt;/p&gt;
 * &lt;pre&gt;
 * OpaqueDOAttributes ::= ObjectValue {CIO-OPAQUE.&amp;Type}
 *
 * ObjectValue { Type } ::= CHOICE {
 * 		indirect ReferencedValue,
 * 		direct [0] Type,
 * 		... -- For future extensions
 * }
 *
 * ReferencedValue ::= CHOICE {
 * 		path Path,
 * 		url URL
 * } -- The syntax of the object is determined by the context
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the CIO
 * <span class="attrib">@see</span> PKCS15_CommonDataContainerObjectAttributes PKCS15_CommonDataContainerObjectAttributes is the base class
 */</span>
<span class="reserved">function</span> PKCS15_DataContainerObject(tlv) {
	<span class="comment">// Call superclass constructor</span>
	PKCS15_CommonDataContainerObjectAttributes.call(<span class="reserved">this</span>, tlv);

	<span class="reserved">if</span> (tlv &amp;&amp; (tlv instanceof ASN1)) {
		
		var t = tlv.get(2);
		assert(t.tag == 0xA1);
		assert(t.elements == 1);
		t.setName(<span class="literal">"typeAttributes"</span>);
		t = t.get(0);
		t.setName(<span class="literal">"dataContainerAttributes"</span>);
		
		switch(tlv.tag) {
		case 0x30: <span class="reserved">this</span>.decodeOpaqueDOIndirectPath(t); break;
		default: 
			print(<span class="literal">"### Unsupported data container object type : "</span> + t);
		}
	}
}

PKCS15_DataContainerObject.<span class="reserved">prototype</span> = new PKCS15_CommonDataContainerObjectAttributes();



<span class="comment">/**
 * Decodes an oqaque data object.
 *
 * <span class="attrib">@private</span>
 * <span class="attrib">@param</span> {ASN1} the tlv structure containing the opaque data object
 */</span>
PKCS15_DataContainerObject.<span class="reserved">prototype</span>.decodeOpaqueDOIndirectPath = <span class="reserved">function</span>(tlv) {
	<span class="reserved">this</span>.type = <span class="literal">"OpaqueDOIndirectPath"</span>; 
	tlv.setName(<span class="literal">"OpaqueDOIndirectPath"</span>);
	
	<span class="reserved">this</span>.indirectPath = new PKCS15_Path(tlv);
}



<span class="comment">/**
 * Convert the object to a human readable string
 *
 * <span class="attrib">@return</span> the string representation of the object
 * <span class="attrib">@type</span> String
 */</span>
PKCS15_DataContainerObject.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {

	var str = PKCS15_CommonDataContainerObjectAttributes.<span class="reserved">prototype</span>.toString.call(<span class="reserved">this</span>);
	str += <span class="literal">"\nDataContainerObject { "</span>;

	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.indirectPath) != <span class="literal">"undefined"</span>) {
		str += <span class="literal">"indirectPath="</span> + <span class="reserved">this</span>.indirectPath + <span class="literal">",\n"</span>;
	}

	str += <span class="literal">"}"</span>;
	<span class="reserved">return</span> str;
}



<span class="comment">/**
 * Create an object to access the PKCS#15 structure on a card.
 *
 * <span class="attrib">@class</span> &lt;p&gt;This class provides for direct access to a PKCS#15 data structure on a card.&lt;/p&gt;
 * &lt;p&gt;The calling application will typically use:&lt;/p&gt;
 * &lt;pre&gt;
 * var card = new Card(_scsh3.reader);
 * var p15 = new PKCS15(card);
 * var appllist = p15.readApplicationDirectory();
 * var aid;
 * for (var i in appllist) {
 *   print(i);
 *   aid = i;
 * }
 * var at = appllist[aid];
 * p15.readObjectListForApplication(at);
 * for (var i = 0; i &lt; at.objlist.length; i++) {
 *   print(at.objlist[i]);
 * }
 * &lt;/pre&gt;
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {Card} card the card object to use for card access.
 */</span>
<span class="reserved">function</span> PKCS15(card) {
	<span class="reserved">this</span>.card = card;
}



<span class="comment">/**
 * Reads the application directory from EF_DIR.
 *
 * &lt;p&gt;The method supports linear variable and transparent EFs. It creates an internal table of
 *    of applications.&lt;/p&gt;
 *
 * <span class="attrib">@return</span> hash table of application templates index by application identifier
 * <span class="attrib">@type</span> PKCS15_ApplicationTemplate[]
 */</span>
PKCS15.<span class="reserved">prototype</span>.readApplicationDirectory = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.ef_dir = new CardFile(<span class="reserved">this</span>.card, <span class="literal">":3F00:2F00"</span>);

	<span class="reserved">this</span>.aidlist = new Array();

	<span class="reserved">if</span> (<span class="reserved">this</span>.ef_dir.isTransparent()) {
		var data = <span class="reserved">this</span>.ef_dir.readBinary();
<span class="comment">//		print(data);</span>

		<span class="reserved">while</span>((data.length &gt; 0) &amp;&amp; (data.byteAt(0) == 0x61)) {
			var tlv = new ASN1(data);
<span class="comment">//			print(tlv);</span>
			data = data.bytes(tlv.size);
<span class="comment">//			print(data);</span>
		
			var at = new PKCS15_ApplicationTemplate(tlv);
			<span class="reserved">this</span>.aidlist[at.aid] = at;
		}
		
	} <span class="reserved">else</span> {
		var rec = 1;
		<span class="reserved">while</span>(rec &lt; 256) {
			var data;
			try {
				data = <span class="reserved">this</span>.ef_dir.readRecord(rec);
			}
			catch(e) {
				<span class="reserved">if</span> (!(e instanceof GPError) || (e.error != GPError.CARD_COMM_ERROR)) {
					print(e);
					throw(e);
				}
				break;
			}

			var tlv = new ASN1(data);
			var at = new PKCS15_ApplicationTemplate(tlv);
			<span class="reserved">this</span>.aidlist[at.aid] = at;
			rec++;
		}
	}
	<span class="reserved">return</span> <span class="reserved">this</span>.aidlist;
}



<span class="comment">/**
 * Reads from the transparent file referenced in the PKCS#15 path object.
 *
 * <span class="attrib">@private</span>
 * <span class="attrib">@param</span> {String} df the current DF in OCF path notation.
 * <span class="attrib">@param</span> {PKCS15_Path} path the relative or absolute path to the EF
 * <span class="attrib">@return</span> the content of the file
 * <span class="attrib">@type</span> ByteString
 */</span>
PKCS15.<span class="reserved">prototype</span>.readCardObject = <span class="reserved">function</span>(df, path) {
	
	var p = path.getAbsolutePath(df);
	print(<span class="literal">"Reading from: "</span> + p);
	var ef = new CardFile(<span class="reserved">this</span>.card, p);
	var data;
	<span class="reserved">if</span> (path.index) {
		data = ef.readBinary(path.index, path.length);
	} <span class="reserved">else</span> {
		var len = ef.getLength();
		data = ef.readBinary(0, len);
	}
	<span class="reserved">return</span> data;
}



<span class="comment">/**
 * Parse a list of TLV objects
 *
 * <span class="attrib">@param</span> {ByteString} data the binary data with TLV objects
 * <span class="attrib">@return</span> the list of ASN1 objects
 * <span class="attrib">@type</span> ASN1[]
 */</span>
PKCS15.parseObjectList = <span class="reserved">function</span>(data) {

	var list = new Array();
	var len = data.length;

	<span class="reserved">while</span>(len &gt; 0) {
		<span class="reserved">if</span> ((data.byteAt(0) == 0x00) || (data.byteAt(0) == 0xFF)) {
			len--;
			data = data.bytes(1);
		} <span class="reserved">else</span> {
<span class="comment">//			print(data);</span>
			var tlv = new ASN1(data);
			var tlvsize = tlv.size;
			len -= tlvsize;
			data = data.bytes(tlvsize);
			list.push(tlv);
<span class="comment">//			print("parseObjectList: " + tlv);</span>
		}
	}
	<span class="reserved">return</span> list;
}



<span class="comment">/**
 * Reads PKCS#15 objects from card file which can be either transparent or record oriented.
 *
 * <span class="attrib">@param</span> {String} df the current DF in OCF path notation.
 * <span class="attrib">@param</span> {PKCS15_Path} path the relative or absolute path to the EF
 * <span class="attrib">@return</span> the array of TLV objects read from the file
 * <span class="attrib">@type</span> ASN1[]
 */</span>
PKCS15.<span class="reserved">prototype</span>.readCardObjects = <span class="reserved">function</span>(df, path) {
	
	var p = path.getAbsolutePath(df);
	print(<span class="literal">"Reading from: "</span> + p);
	var ef = new CardFile(<span class="reserved">this</span>.card, p);
	var list = new Array();
	
	<span class="reserved">if</span> (ef.isTransparent()) {
		var data;
		<span class="reserved">if</span> (path.index) {
			data = ef.readBinary(path.index, path.length);
		} <span class="reserved">else</span> {
			var len = ef.getLength();
			data = ef.readBinary(0, len);
		}
		
		var len = data.length;

		try	{
			<span class="reserved">while</span>(len &gt; 0) {
				<span class="reserved">if</span> ((data.byteAt(0) == 0x00) || (data.byteAt(0) == 0xFF)) {
					len--;
					data = data.bytes(1);
				} <span class="reserved">else</span> {
<span class="comment">//					print(data);</span>
					var tlv = new ASN1(data);
					var tlvsize = tlv.size;
					len -= tlvsize;
					data = data.bytes(tlvsize);
					list.push(tlv);
<span class="comment">//					print("readCardObjects: " + tlv);</span>
				}
			}
		}
		catch(e) {
			print(<span class="literal">"Error reading cryptographic information object: "</span> + e);
			print(data);
		}
	} <span class="reserved">else</span> {
		var rec = 1;
		<span class="reserved">while</span>(rec &lt; 256) {
			var data;
			try {
				data = ef.readRecord(rec);
			}
			catch(e) {
				<span class="reserved">if</span> (!(e instanceof GPError) || (e.error != GPError.CARD_COMM_ERROR)) {
					print(e);
					throw(e);
				}
				break;
			}

			data = data.bytes(2);	<span class="comment">// Strip of first two bytes</span>
<span class="comment">//			print("Data : " + data);</span>
			<span class="reserved">if</span> (data.length &gt; 2) {	<span class="comment">// Record might be empty</span>
				try	{
					var tlv = new ASN1(data);
					list.push(tlv);
<span class="comment">//					print("readCardObjects: " + tlv);</span>
				}
				catch(e) {
					print(<span class="literal">"Error reading cryptographic information object: "</span> + e);
					print(data);
				}
			}
			rec++;
		}
	}
	<span class="reserved">return</span> list;
}



<span class="comment">/**
 * Reads all CIO objects for an application and adds the CIO objects to the objlist property
 *
 * <span class="attrib">@param</span> {PKCS15_ApplicationTemplate} at the application template
 */</span>
PKCS15.<span class="reserved">prototype</span>.readObjectListForApplication = <span class="reserved">function</span>(at) {
	<span class="reserved">if</span> (!at.ddo) {
		throw new Error(<span class="literal">"Application has no PKCS#15 information"</span>);
	}

	<span class="reserved">if</span> (!at.ddo.odfPath) {
		throw new Error(<span class="literal">"Application has no odfPath"</span>);
	}
	
	at.objlist = new Array();

	var dos = <span class="reserved">this</span>.readCardObjects(<span class="literal">":3F00"</span>, at.ddo.odfPath);

	<span class="comment">// Determine current DF</span>
	var df = at.ddo.odfPath.getAbsolutePath(<span class="literal">":3F00"</span>);
	df = df.slice(0, -5);
	<span class="reserved">this</span>.df = df;
	
	<span class="reserved">for</span> (var i = 0; i &lt; dos.length; i++) {
		var tlv = dos[i];
		assert(tlv.isconstructed);
		var ciotype = tlv.tag;
		var path = new PKCS15_Path(tlv.get(0));
		
<span class="comment">//		print("Path = " + path);</span>
		var cios = <span class="reserved">this</span>.readCardObjects(df, path);

		<span class="reserved">for</span> (var j = 0; j &lt; cios.length; j++) {
			var tlv = cios[j];

			var cio;
			switch(ciotype) {
				case 0xA0:
					cio = new PKCS15_PrivateKey(tlv);
<span class="comment">//					cio.type = "PrivateKey";</span>
					break;
				case 0xA1:
					cio = new PKCS15_PublicKey(tlv);
					cio = new PKCS15_CIO(tlv);
					cio.type = <span class="literal">"PublicKey"</span>;
					break;
				case 0xA2:
<span class="comment">//					cio = new PKCS15_PublicKey(tlv);</span>
					cio = new PKCS15_CIO(tlv);
					cio.type = <span class="literal">"TrustedPublicKey"</span>;
					break;
				case 0xA3:
<span class="comment">//					cio = new PKCS15_SecretKey(tlv);</span>
					cio = new PKCS15_CIO(tlv);
					cio.type = <span class="literal">"SecretKey"</span>;
					break;
				case 0xA4:
					cio = new PKCS15_Certificate(tlv);
<span class="comment">//					cio.type = "Certificate";</span>
					break;
				case 0xA5:
					cio = new PKCS15_Certificate(tlv);
					cio.type = <span class="literal">"Trusted"</span> + cio.type;
					break;
				case 0xA6:
					cio = new PKCS15_Certificate(tlv);
					cio.type = <span class="literal">"Useful"</span> + cio.type;
					break;
				case 0xA7:
					cio = new PKCS15_DataContainerObject(tlv);
					cio.type = <span class="literal">"DataContainerObject"</span>;
					break;
				case 0xA8:
					cio = new PKCS15_AuthenticationObject(tlv);
					cio.type = <span class="literal">"AuthObject"</span>;
					break;
				default:
					assert(false);
			}
			at.objlist.push(cio);
		}
	}
}



<span class="comment">/**
 * Reads and return the CIAInfo structure referenced by the PKCS#15 path element.
 *
 * <span class="attrib">@param</span> {PKCS15_Path} path the path to the CIAInfo file
 * <span class="attrib">@return</span> the CIAInfo description
 * <span class="attrib">@type</span> PKCS15_CIAInfo
 */</span>
PKCS15.<span class="reserved">prototype</span>.getCIAInfo = <span class="reserved">function</span>(path) {

	var cia = <span class="reserved">this</span>.readCardObject(<span class="literal">":3F00"</span>, path);
	var tlv = new ASN1(cia);
	<span class="reserved">return</span> new PKCS15_CIAInfo(tlv);
}



<span class="comment">/**
 * Return the hash table of application templates
 *
 * <span class="attrib">@return</span> the hash table of application templates
 * <span class="attrib">@type</span> PKCS15_ApplicationTemplate[]
 */</span>
PKCS15.<span class="reserved">prototype</span>.getAidList = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.aidlist;
}

</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Fri Dec  3 18:14:23 2010</div>
</body>
</html>
